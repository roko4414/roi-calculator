<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APG ROI Calculator</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&display=swap">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'DM Sans', sans-serif;
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }

    *::-webkit-scrollbar {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
    }

    html, body {
      overflow-x: hidden !important;
      overflow-y: auto !important;
    }

    body {
      color: white;
      background-color: #0a0a0a;
    }

    /* Container */
    .calculator-container {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .calculator-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .calculator-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .calculator-header p {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .step-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 24px;
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .step-indicator:hover {
      background: rgba(255,255,255,0.08);
    }

    .step-indicator.active {
      background: rgba(125, 255, 0, 0.15);
      color: #7DFF00;
      border-color: rgba(125, 255, 0, 0.3);
    }

    .step-indicator.completed {
      background: rgba(125, 255, 0, 0.1);
      color: #7DFF00;
      cursor: pointer;
    }

    .step-indicator.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .step-indicator.locked:hover {
      background: rgba(255,255,255,0.05);
    }

    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
    }

    .step-indicator.active .step-number,
    .step-indicator.completed .step-number {
      background: #7DFF00;
      color: #0a0a0a;
    }

    /* Panel */
    .panel {
      background: rgba(20, 20, 20, 0.9);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .panel-title {
      font-size: 20px;
      font-weight: 600;
    }

    .panel-subtitle {
      color: rgba(255,255,255,0.5);
      font-size: 14px;
      margin-top: 4px;
    }

    /* Step Content */
    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    /* Category Sections */
    .category-section {
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      overflow: hidden;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .category-header:hover {
      background: rgba(255,255,255,0.05);
    }

    .category-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 15px;
    }

    .category-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(125, 255, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7DFF00;
    }

    .category-icon svg {
      width: 18px;
      height: 18px;
    }

    .category-badge {
      background: rgba(125, 255, 0, 0.2);
      color: #7DFF00;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .category-chevron {
      color: rgba(255,255,255,0.4);
      transition: transform 0.2s ease;
    }

    .category-section.expanded .category-chevron {
      transform: rotate(180deg);
    }

    .category-tools {
      display: none;
      padding: 16px;
      background: rgba(0,0,0,0.2);
    }

    .category-section.expanded .category-tools {
      display: block;
    }

    /* Group Selection Grid (Phase 0) */
    .group-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .group-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 24px 16px;
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      position: relative;
    }

    .group-item:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.2);
    }

    .group-item.selected {
      border-color: #7DFF00;
      background: rgba(125, 255, 0, 0.08);
    }

    .group-checkbox {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .group-item.selected .group-checkbox {
      background: #7DFF00;
      border-color: #7DFF00;
    }

    .group-checkbox svg {
      width: 16px;
      height: 16px;
      stroke: #0a0a0a;
      stroke-width: 3;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .group-item.selected .group-checkbox svg {
      opacity: 1;
    }

    .group-item-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(125, 255, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7DFF00;
    }

    .group-item-icon svg {
      width: 24px;
      height: 24px;
    }

    .group-item-name {
      font-size: 14px;
      font-weight: 600;
      color: white;
      line-height: 1.3;
    }


    /* Category Selection Grid (Phase 1) */
    .category-checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .category-checkbox-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .category-checkbox-item:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.15);
    }

    .category-checkbox-item.checked {
      background: rgba(125, 255, 0, 0.08);
      border-color: #7DFF00;
    }

    .category-checkbox-item .checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .category-checkbox-item.checked .checkbox {
      background: #7DFF00;
      border-color: #7DFF00;
    }

    .category-checkbox-item .checkbox svg {
      width: 14px;
      height: 14px;
      stroke: #0a0a0a;
      stroke-width: 3;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .category-checkbox-item.checked .checkbox svg {
      opacity: 1;
    }

    .category-checkbox-item .category-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .category-checkbox-item .category-icon {
      width: 32px;
      height: 32px;
      background: rgba(125, 255, 0, 0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .category-checkbox-item .category-icon svg {
      width: 18px;
      height: 18px;
      stroke: #7DFF00;
    }

    .category-checkbox-item .category-label {
      font-size: 14px;
      font-weight: 500;
      color: white;
    }

    .category-selection-footer {
      margin-top: 24px;
      display: flex;
      justify-content: center;
    }

    .continue-btn {
      background: #7DFF00;
      color: #0a0a0a;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .continue-btn:hover:not(:disabled) {
      background: #9fff40;
      transform: translateY(-1px);
    }

    .continue-btn:disabled {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.3);
      cursor: not-allowed;
    }

    #selectedCategoryCount {
      opacity: 0.7;
      font-weight: 400;
    }

    /* Phase 2: Sequential Tool Selection */
    .back-to-categories-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.7);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .back-to-categories-btn:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.3);
      color: white;
    }

    .category-nav-buttons {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .category-nav-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .category-nav-btn.prev {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.7);
    }

    .category-nav-btn.prev:hover:not(:disabled) {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.3);
      color: white;
    }

    .category-nav-btn.prev:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .category-nav-btn.next {
      background: #7DFF00;
      border: none;
      color: #0a0a0a;
    }

    .category-nav-btn.next:hover {
      background: #9fff40;
    }

    #categoryProgress {
      color: rgba(255,255,255,0.5);
    }

    /* Tool Items */
    .tool-item {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 12px;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.02);
      transition: background 0.2s ease;
    }

    .tool-item:hover {
      background: rgba(255,255,255,0.05);
    }

    .tool-item:last-child {
      margin-bottom: 0;
    }

    .tool-name-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tool-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .tool-checkbox.checked {
      background: #7DFF00;
      border-color: #7DFF00;
    }

    .tool-checkbox.checked::after {
      content: "✓";
      color: #0a0a0a;
      font-weight: 700;
      font-size: 12px;
    }

    .tool-name {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }

    .tool-item.selected .tool-name {
      color: white;
    }

    /* Tier Select */
    .tools-helper-text {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 12px;
      padding: 0 4px;
    }

    .scroll-hint {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      color: #7DFF00;
      font-size: 13px;
      font-weight: 500;
    }

    .scroll-hint svg {
      animation: bounceArrow 2s infinite;
    }

    @keyframes bounceArrow {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(4px); }
    }

    @media (max-width: 768px) {
      .scroll-hint {
        display: flex;
      }
    }

    .tier-select {
      display: flex;
      gap: 4px;
    }

    .tier-btn {
      padding: 6px 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: transparent;
      color: rgba(255,255,255,0.5);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .tier-btn:hover {
      border-color: rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.8);
    }

    .tier-btn.active {
      background: #7DFF00;
      border-color: #7DFF00;
      color: #0a0a0a;
      font-weight: 600;
    }

    .tier-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* User Count Input */
    .user-count {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-count-input {
      width: 60px;
      padding: 6px 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.3);
      color: white;
      border-radius: 6px;
      font-size: 13px;
      text-align: center;
    }

    .user-count-input:focus {
      outline: none;
      border-color: #7DFF00;
    }

    .user-count-label {
      font-size: 12px;
      color: rgba(255,255,255,0.4);
    }

    /* Tool Cost Display */
    .tool-cost {
      font-size: 13px;
      color: #7DFF00;
      font-weight: 600;
      min-width: 80px;
      text-align: right;
    }

    /* Waste Category */
    .waste-intro-text {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .waste-item {
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .waste-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .waste-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .waste-description {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      max-width: 400px;
    }

    .waste-cost {
      font-size: 18px;
      font-weight: 700;
      color: #7DFF00;
    }

    .waste-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-label {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      font-weight: 500;
    }

    .slider-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #7DFF00;
      cursor: pointer;
      border: 2px solid rgba(0,0,0,0.2);
    }

    .slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #7DFF00;
      cursor: pointer;
      border: 2px solid rgba(0,0,0,0.2);
    }

    .slider-value {
      min-width: 50px;
      padding: 6px 10px;
      background: rgba(125, 255, 0, 0.15);
      color: #7DFF00;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }

    /* AI Capabilities Grid */
    .ai-capabilities-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .ai-capability-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: rgba(125, 255, 0, 0.05);
      border: 1px solid rgba(125, 255, 0, 0.15);
      border-radius: 10px;
    }

    .ai-capability-icon {
      font-size: 14px;
      flex-shrink: 0;
      color: #7DFF00;
      font-weight: bold;
    }

    .ai-capability-text {
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      line-height: 1.3;
    }

    .ai-summary-box {
      background: linear-gradient(135deg, rgba(125, 255, 0, 0.1) 0%, rgba(125, 255, 0, 0.05) 100%);
      border: 1px solid rgba(125, 255, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .ai-summary-text {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
    }

    .ai-summary-value {
      font-size: 36px;
      font-weight: 700;
      color: #7DFF00;
      margin-bottom: 4px;
    }

    .ai-summary-subtext {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }

    .ai-toggle {
      width: 44px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      transition: background 0.2s ease;
    }

    .ai-toggle.active {
      background: #7DFF00;
    }

    .ai-toggle::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s ease;
    }

    .ai-toggle.active::after {
      transform: translateX(20px);
      background: #0a0a0a;
    }

    .ai-info h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .ai-info p {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }

    .ai-savings {
      text-align: right;
    }

    .ai-savings-amount {
      font-size: 16px;
      font-weight: 700;
      color: #7DFF00;
    }

    .ai-savings-label {
      font-size: 11px;
      color: rgba(255,255,255,0.4);
    }

    /* APG Tier Selection */
    .tier-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .tier-cards {
        grid-template-columns: 1fr;
      }
    }

    .tier-card {
      padding: 24px;
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .tier-card:hover {
      border-color: rgba(125, 255, 0, 0.3);
      background: rgba(255,255,255,0.05);
    }

    .tier-card.selected {
      border-color: #7DFF00;
      background: rgba(125, 255, 0, 0.1);
    }

    .tier-card-badge {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .tier-card.selected .tier-card-badge {
      background: #7DFF00;
      color: #0a0a0a;
    }

    .tier-card-price {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .tier-card-subtitle {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 16px;
    }

    .tier-card-maintenance {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    /* Summary Dashboard */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 640px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-card {
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .summary-card-label {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 8px;
    }

    .summary-card-value {
      font-size: 28px;
      font-weight: 700;
    }

    .summary-card-value.green {
      color: #7DFF00;
    }

    .summary-card-value.red {
      color: #ff6b6b;
    }

    .summary-card-subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.4);
      margin-top: 4px;
    }

    /* Chart Container */
    .chart-container {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    #roiChart {
      width: 100%;
      height: 340px;
    }

    /* Breakdown */
    .breakdown-section {
      margin-top: 24px;
    }

    .breakdown-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .breakdown-item:last-child {
      border-bottom: none;
    }

    .breakdown-label {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }

    .breakdown-value {
      font-size: 14px;
      font-weight: 600;
    }

    .breakdown-value.negative {
      color: #ff6b6b;
    }

    .breakdown-value.positive {
      color: #7DFF00;
    }

    /* Navigation Buttons */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-top: 24px;
      margin-bottom: 20px;
    }

    .nav-btn {
      padding: 14px 32px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .nav-btn.secondary {
      background: rgba(255,255,255,0.08);
      color: white;
    }

    .nav-btn.secondary:hover {
      background: rgba(255,255,255,0.12);
    }

    .nav-btn.primary {
      background: #7DFF00;
      color: #0a0a0a;
    }

    .nav-btn.primary:hover {
      background: #6ee600;
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Running Total Bar */
    .running-total {
      position: sticky;
      bottom: 0;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 16px 24px;
      margin: 0 -24px -24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .running-total-item {
      text-align: center;
    }

    .running-total-label {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 4px;
    }

    .running-total-value {
      font-size: 18px;
      font-weight: 700;
      color: #7DFF00;
    }

    .running-total-value.red {
      color: #ff6b6b;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .calculator-container {
        padding: 16px;
      }

      .calculator-header h1 {
        font-size: 22px;
      }

      .calculator-header p {
        font-size: 12px;
      }

      .panel {
        padding: 16px;
      }

      .panel-title {
        font-size: 17px;
      }

      .category-header {
        padding: 12px;
      }

      .category-title {
        font-size: 13px;
        gap: 8px;
      }

      .category-icon {
        width: 28px;
        height: 28px;
      }

      .category-icon svg {
        width: 14px;
        height: 14px;
      }

      .category-cost {
        font-size: 12px;
      }

      .category-tools {
        padding: 12px;
      }

      /* Category selection grid mobile - compact 2-column layout */
      .category-checkbox-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        max-height: 400px;
        overflow-y: auto;
        padding-right: 4px;
        scrollbar-width: thin !important;
        -ms-overflow-style: auto !important;
      }

      .category-checkbox-grid::-webkit-scrollbar {
        display: block !important;
        width: 4px !important;
      }

      .category-checkbox-grid::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 2px;
      }

      .category-checkbox-grid::-webkit-scrollbar-thumb {
        background: rgba(125, 255, 0, 0.3);
        border-radius: 2px;
      }

      .category-checkbox-item {
        padding: 10px;
        gap: 8px;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .category-checkbox-item .checkbox {
        width: 18px;
        height: 18px;
        position: absolute;
        top: 6px;
        right: 6px;
      }

      .category-checkbox-item {
        position: relative;
      }

      .category-checkbox-item .category-info {
        flex-direction: column;
        gap: 6px;
      }

      .category-checkbox-item .category-icon {
        width: 32px;
        height: 32px;
      }

      .category-checkbox-item .category-icon svg {
        width: 16px;
        height: 16px;
      }

      .category-checkbox-item .category-label {
        font-size: 11px;
        line-height: 1.2;
      }

      .continue-btn {
        width: 100%;
        padding: 12px 24px;
        font-size: 14px;
      }

      .back-to-categories-btn {
        font-size: 12px;
        padding: 6px 12px;
      }

      .category-nav-buttons {
        flex-direction: column;
        gap: 10px;
      }

      .category-nav-btn {
        width: 100%;
        text-align: center;
        padding: 12px 20px;
        font-size: 13px;
      }

      #categoryProgress {
        font-size: 12px;
      }

      /* Scrollable tools container on mobile */
      .tools-scroll-container {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 4px;
        scrollbar-width: thin !important;
        -ms-overflow-style: auto !important;
      }

      .tools-scroll-container::-webkit-scrollbar {
        display: block !important;
        width: 4px !important;
      }

      .tools-scroll-container::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 2px;
      }

      .tools-scroll-container::-webkit-scrollbar-thumb {
        background: rgba(125, 255, 0, 0.3);
        border-radius: 2px;
      }

      /* Compact tool items on mobile */
      .tool-item {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        align-items: center;
      }

      .tool-name-section {
        flex: 1;
        min-width: 120px;
      }

      .tool-name {
        font-size: 13px;
      }

      .tier-select {
        display: flex;
        gap: 2px;
      }

      .tier-btn {
        padding: 4px 6px;
        font-size: 10px;
      }

      .user-count {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .user-count-input {
        width: 45px;
        padding: 4px 6px;
        font-size: 11px;
      }

      .user-count-label {
        font-size: 10px;
      }

      .tool-cost {
        font-size: 12px;
        font-weight: 600;
        min-width: 70px;
        text-align: right;
      }

      .waste-item {
        padding: 14px;
      }

      .waste-title {
        font-size: 14px;
      }

      .waste-description {
        font-size: 11px;
      }

      .waste-cost {
        font-size: 15px;
      }

      .waste-inputs {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .input-label {
        font-size: 11px;
      }

      .slider-value {
        min-width: 45px;
        padding: 5px 8px;
        font-size: 12px;
      }

      .ai-agents-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .ai-capabilities-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .ai-capability-item {
        padding: 10px;
        gap: 8px;
      }

      .ai-capability-icon {
        font-size: 18px;
      }

      .ai-capability-text {
        font-size: 12px;
      }

      .ai-summary-box {
        padding: 16px;
      }

      .ai-summary-value {
        font-size: 28px;
      }

      .ai-summary-text,
      .ai-summary-subtext {
        font-size: 13px;
      }

      .results-hero {
        padding: 24px 16px;
      }

      .results-hero-amount {
        font-size: 40px;
      }

      .results-hero-period {
        font-size: 14px;
      }

      .results-card {
        padding: 14px;
        gap: 12px;
      }

      .results-card-icon {
        width: 40px;
        height: 40px;
      }

      .results-card-value {
        font-size: 16px;
      }

      .cta-panel {
        padding: 32px 16px;
      }

      .cta-icon {
        width: 64px;
        height: 64px;
      }

      .cta-title {
        font-size: 24px;
      }

      .cta-subtitle {
        font-size: 14px;
      }

      .cta-stat-value {
        font-size: 22px;
      }

      .cta-urgency {
        padding: 10px 16px;
        font-size: 12px;
      }

      .cta-button {
        padding: 14px 28px;
        font-size: 14px;
      }

      .nav-buttons {
        margin-top: 16px;
        margin-bottom: 16px;
      }

      .nav-btn {
        padding: 12px 20px;
        font-size: 13px;
      }

      .running-total {
        padding: 12px 16px;
        margin: 0 -16px -16px;
        gap: 8px;
      }

      .running-total-item {
        flex: 1;
        min-width: 70px;
      }

      .running-total-label {
        font-size: 9px;
      }

      .running-total-value {
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      .progress-steps {
        gap: 4px;
      }

      .step-indicator {
        padding: 6px 10px;
        font-size: 11px;
      }

      .step-indicator .step-label {
        display: none;
      }

      .step-number {
        width: 22px;
        height: 22px;
        font-size: 11px;
      }

      .running-total {
        flex-wrap: wrap;
        justify-content: center;
      }

      .running-total-item {
        min-width: 45%;
      }
    }

    /* Category Cost Summary */
    .category-cost {
      font-size: 14px;
      color: #7DFF00;
      font-weight: 600;
    }

    /* Results Hero */
    .results-hero {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(255, 107, 107, 0.05) 100%);
      border-radius: 16px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 107, 107, 0.2);
    }

    .results-hero-label {
      font-size: 16px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
    }

    .results-hero-amount {
      font-size: 56px;
      font-weight: 800;
      color: #ff6b6b;
      line-height: 1;
      margin-bottom: 8px;
    }

    .results-hero-period {
      font-size: 18px;
      color: rgba(255,255,255,0.5);
    }

    /* Results Cards */
    .results-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .results-cards {
        grid-template-columns: 1fr;
      }
    }

    .results-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .results-card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.6);
    }

    .results-card-label {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 4px;
    }

    .results-card-value {
      font-size: 20px;
      font-weight: 700;
      color: #ff6b6b;
    }

    .results-card-value.green {
      color: #7DFF00;
    }

    .results-chart-container {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    #resultsChart {
      width: 100%;
      height: 280px;
    }

    /* CTA Panel */
    .cta-panel {
      text-align: center;
      padding: 48px 24px;
    }

    .cta-header {
      margin-bottom: 32px;
    }

    .cta-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(125, 255, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      color: #7DFF00;
    }

    .cta-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .cta-subtitle {
      font-size: 16px;
      color: rgba(255,255,255,0.6);
      max-width: 400px;
      margin: 0 auto;
    }

    .cta-stats {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .cta-stat {
      text-align: center;
    }

    .cta-stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .cta-stat-value.red {
      color: #ff6b6b;
    }

    .cta-stat-value.green {
      color: #7DFF00;
    }

    .cta-stat-label {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
    }

    .cta-urgency {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.2);
      border-radius: 24px;
      margin-bottom: 32px;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }

    .cta-urgency-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .cta-urgency strong {
      color: #ff6b6b;
    }

    .cta-button {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 18px 40px;
      background: #7DFF00;
      color: #0a0a0a;
      font-size: 16px;
      font-weight: 700;
      border-radius: 12px;
      text-decoration: none;
      transition: all 0.2s ease;
      margin-bottom: 16px;
    }

    .cta-button:hover {
      background: #6ee600;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(125, 255, 0, 0.3);
    }

    .cta-note {
      font-size: 13px;
      color: rgba(255,255,255,0.4);
    }
  </style>
</head>
<body>
<div class="calculator-container">
  <div class="calculator-header">
    <h1>APG ROI Calculator</h1>
    <p>Calculate your losses</p>
  </div>

  <!-- Progress Steps -->
  <div class="progress-steps">
    <div class="step-indicator active" data-step="1">
      <span class="step-number">1</span>
      <span class="step-label">SaaS Tools</span>
    </div>
    <div class="step-indicator" data-step="2">
      <span class="step-number">2</span>
      <span class="step-label">Inefficiencies</span>
    </div>
    <div class="step-indicator" data-step="3">
      <span class="step-number">3</span>
      <span class="step-label">AI Enablement</span>
    </div>
    <div class="step-indicator" data-step="4">
      <span class="step-number">4</span>
      <span class="step-label">Your Results</span>
    </div>
    <div class="step-indicator" data-step="5">
      <span class="step-number">5</span>
      <span class="step-label">Get Quote</span>
    </div>
  </div>

  <!-- Step 1: SaaS Tools -->
  <div class="step-content active" id="step1">
    <!-- Phase 1: Group Selection (checkboxes) -->
    <div class="panel" id="groupSelectionPhase">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">What areas does your team work in?</h2>
          <p class="panel-subtitle">Select all that apply</p>
        </div>
      </div>
      <div id="groupGrid" class="group-grid"></div>
      <div class="category-selection-footer">
        <button class="continue-btn" id="continueFromGroupsBtn" disabled>
          Continue <span id="selectedGroupCount">(0 selected)</span>
        </button>
      </div>
    </div>

    <!-- Phase 2: Category Selection (sequential per group) -->
    <div class="panel" id="categorySelectionPhase" style="display: none;">
      <div class="panel-header">
        <div>
          <h2 class="panel-title" id="groupTitle">Sales & Marketing</h2>
          <p class="panel-subtitle" id="groupProgress">Group 1 of 2 — Select the categories you use</p>
        </div>
      </div>
      <div id="categoryCheckboxGrid" class="category-checkbox-grid"></div>
      <div class="category-nav-buttons">
        <button class="category-nav-btn prev" id="prevGroupBtn">← Back</button>
        <button class="category-nav-btn next" id="nextGroupBtn">Next →</button>
      </div>
    </div>

    <!-- Phase 3: Tool Selection (sequential per category) -->
    <div class="panel" id="toolSelectionPhase" style="display: none;">
      <div class="panel-header">
        <div>
          <h2 class="panel-title" id="currentCategoryTitle">Category Name</h2>
          <p class="panel-subtitle" id="categoryProgress">Category 1 of 3</p>
        </div>
        <button class="back-to-categories-btn" id="backToCategoriesBtn">← Change Categories</button>
      </div>
      <p class="tools-helper-text">Select tools & pick your plan (T1=Basic, T2=Pro, T3=Enterprise)</p>
      <div id="singleCategoryTools" class="tools-scroll-container"></div>
      <div class="scroll-hint" id="scrollHint">
        <span>Scroll for more tools</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12l7 7 7-7"/>
        </svg>
      </div>
      <div class="category-nav-buttons">
        <button class="category-nav-btn prev" id="prevCategoryBtn" disabled>← Previous</button>
        <button class="category-nav-btn next" id="nextCategoryBtn">Next →</button>
      </div>
    </div>
  </div>

  <!-- Step 2: Inefficiency Waste -->
  <div class="step-content" id="step2">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title" id="currentWasteTitle">Inefficiency Name</h2>
          <p class="panel-subtitle" id="wasteProgress">Inefficiency 1 of 5</p>
        </div>
      </div>
      <p class="waste-intro-text">Estimate how much time your team wastes each week on these common frustrations</p>
      <div id="singleWasteItem"></div>
      <div class="category-nav-buttons">
        <button class="category-nav-btn prev" id="prevWasteBtn">← Previous</button>
        <button class="category-nav-btn next" id="nextWasteBtn">Next →</button>
      </div>
    </div>
  </div>

  <!-- Step 3: AI Enablement -->
  <div class="step-content" id="step3">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">What AI Can Automate</h2>
          <p class="panel-subtitle">Here's what becomes possible with the right AI setup</p>
        </div>
      </div>
      <div class="ai-capabilities-grid">
        <div class="ai-capability-item">
          <span class="ai-capability-icon">✦</span>
          <span class="ai-capability-text">Instant answers to company questions</span>
        </div>
        <div class="ai-capability-item">
          <span class="ai-capability-icon">✦</span>
          <span class="ai-capability-text">Handle routine customer inquiries</span>
        </div>
        <div class="ai-capability-item">
          <span class="ai-capability-icon">✦</span>
          <span class="ai-capability-text">Auto-generate reports & insights</span>
        </div>
        <div class="ai-capability-item">
          <span class="ai-capability-icon">✦</span>
          <span class="ai-capability-text">Draft proposals from templates</span>
        </div>
        <div class="ai-capability-item">
          <span class="ai-capability-icon">✦</span>
          <span class="ai-capability-text">Search across all files & data</span>
        </div>
        <div class="ai-capability-item">
          <span class="ai-capability-icon">✦</span>
          <span class="ai-capability-text">Prepare meeting briefings</span>
        </div>
        <div class="ai-capability-item">
          <span class="ai-capability-icon">✦</span>
          <span class="ai-capability-text">Automate project kickoffs</span>
        </div>
        <div class="ai-capability-item">
          <span class="ai-capability-icon">✦</span>
          <span class="ai-capability-text">Flag timesheet anomalies</span>
        </div>
      </div>
      <div class="ai-summary-box">
        <div class="ai-summary-text">Based on your inefficiencies, AI could recover</div>
        <div class="ai-summary-value" id="aiRecoveryPercent">~40%</div>
        <div class="ai-summary-subtext">of that wasted time</div>
      </div>
    </div>
  </div>

  <!-- Step 4: Your Results -->
  <div class="step-content" id="step4">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">Your Results</h2>
          <p class="panel-subtitle">Here's what your current setup is costing you</p>
        </div>
      </div>

      <div class="results-hero">
        <div class="results-hero-label">You're losing</div>
        <div class="results-hero-amount" id="resultsYearlyWaste">$0</div>
        <div class="results-hero-period">per year</div>
      </div>

      <div class="results-cards">
        <div class="results-card">
          <div class="results-card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
          </div>
          <div class="results-card-content">
            <div class="results-card-label">SaaS Tools</div>
            <div class="results-card-value" id="resultsToolsCost">$0/mo</div>
          </div>
        </div>
        <div class="results-card">
          <div class="results-card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          </div>
          <div class="results-card-content">
            <div class="results-card-label">Inefficiency Waste</div>
            <div class="results-card-value" id="resultsWasteCost">$0/mo</div>
          </div>
        </div>
      </div>

      <div class="results-chart-container">
        <h3 class="chart-title">12-Month Cost Projection</h3>
        <canvas id="resultsChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Step 5: Get Your Quote -->
  <div class="step-content" id="step5">
    <div class="panel cta-panel">
      <div class="cta-header">
        <div class="cta-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        </div>
        <h2 class="cta-title">Let's Fix This Together</h2>
        <p class="cta-subtitle">Book a free consultation to see how we can eliminate your waste</p>
      </div>

      <div class="cta-stats">
        <div class="cta-stat">
          <div class="cta-stat-value red" id="ctaMonthlyWaste">$0</div>
          <div class="cta-stat-label">Monthly Waste</div>
        </div>
        <div class="cta-stat">
          <div class="cta-stat-value red" id="ctaYearlyWaste">$0</div>
          <div class="cta-stat-label">Yearly Waste</div>
        </div>
      </div>

      <div class="cta-urgency">
        <svg class="cta-urgency-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2h12M6 22h12M12 6v4l2 2M6 6a6 6 0 0 0 6 6 6 6 0 0 0 6-6M6 18a6 6 0 0 1 6-6 6 6 0 0 1 6 6"></path></svg>
        <span>Every month you wait costs you <strong id="ctaUrgencyAmount">$0</strong></span>
      </div>

      <a href="#" class="cta-button" id="ctaButton">
        Book Your Free Consultation
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
      </a>

      <p class="cta-note">No commitment required. We'll review your results and show you a custom solution.</p>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="nav-buttons">
    <button class="nav-btn secondary" id="prevBtn" disabled>Back</button>
    <button class="nav-btn primary" id="nextBtn">Next Step</button>
  </div>

  <!-- Running Total -->
  <div class="running-total">
    <div class="running-total-item">
      <div class="running-total-label">SaaS Cost/mo</div>
      <div class="running-total-value red" id="runningToolsCost">$0</div>
    </div>
    <div class="running-total-item">
      <div class="running-total-label">Inefficiency/mo</div>
      <div class="running-total-value red" id="runningWasteCost">$0</div>
    </div>
    <div class="running-total-item">
      <div class="running-total-label">Hours Wasted/wk</div>
      <div class="running-total-value red" id="runningWasteHours">0h</div>
    </div>
    <div class="running-total-item">
      <div class="running-total-label">Total Waste/mo</div>
      <div class="running-total-value red" id="runningTotalWaste">$0</div>
    </div>
  </div>
</div>

<script>
// ============================================
// DATA
// ============================================

// SVG Icons
const icons = {
  crm: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
  project: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>`,
  form: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
  social: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>`,
  dashboard: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>`,
  support: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>`,
  invoice: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
  time: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
  communication: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
  automation: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
  document: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`,
  signature: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`,
  calendar: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
  marketing: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>`,
  collaboration: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
  hr: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>`
};

const toolsData = {
  "CRM & Sales": {
    icon: icons.crm,
    tools: [
      { name: "HubSpot", tiers: [15, 50, 125] },
      { name: "Salesforce", tiers: [25, 75, 150] },
      { name: "Pipedrive", tiers: [14, 29, 49] },
      { name: "Zoho CRM", tiers: [14, 23, 40] },
      { name: "Copper", tiers: [29, 69, 134] },
      { name: "Close", tiers: [29, 69, 129] },
      { name: "Monday Sales CRM", tiers: [12, 17, 28] }
    ]
  },
  "Project Management": {
    icon: icons.project,
    tools: [
      { name: "Asana", tiers: [10.99, 24.99, 50] },
      { name: "Monday.com", tiers: [9, 12, 19] },
      { name: "ClickUp", tiers: [7, 12, 19] },
      { name: "Trello", tiers: [5, 10, 17.50] },
      { name: "Wrike", tiers: [9.80, 24.80, 50] },
      { name: "Smartsheet", tiers: [9, 19, 39] }
    ]
  },
  "Form Tools": {
    icon: icons.form,
    tools: [
      { name: "Typeform", tiers: [25, 50, 83] },
      { name: "Jotform", tiers: [34, 39, 99] },
      { name: "Wufoo", tiers: [14, 29, 74] },
      { name: "Cognito Forms", tiers: [10, 15, 25] },
      { name: "SurveyMonkey", tiers: [25, 35, 75] },
      { name: "Formstack", tiers: [50, 83, 208] }
    ]
  },
  "Social Media": {
    icon: icons.social,
    tools: [
      { name: "Buffer", tiers: [6, 12, 120] },
      { name: "Hootsuite", tiers: [99, 249, 739] },
      { name: "Later", tiers: [18, 40, 80] },
      { name: "Sprout Social", tiers: [249, 399, 499] },
      { name: "SocialBee", tiers: [29, 49, 99] },
      { name: "Planoly", tiers: [13, 23, 43] }
    ]
  },
  "Dashboards & BI": {
    icon: icons.dashboard,
    tools: [
      { name: "Tableau", tiers: [70, 70, 70] },
      { name: "Power BI", tiers: [10, 20, 20] },
      { name: "Metabase", tiers: [0, 85, 85] },
      { name: "Databox", tiers: [47, 135, 231] },
      { name: "Klipfolio", tiers: [49, 199, 799] }
    ]
  },
  "Support & Help Desk": {
    icon: icons.support,
    tools: [
      { name: "Zendesk", tiers: [19, 49, 99] },
      { name: "Freshdesk", tiers: [15, 49, 79] },
      { name: "Help Scout", tiers: [20, 40, 65] },
      { name: "Intercom", tiers: [74, 119, 219] },
      { name: "Front", tiers: [19, 49, 99] },
      { name: "Groove", tiers: [12, 20, 40] }
    ]
  },
  "Invoicing & Accounting": {
    icon: icons.invoice,
    tools: [
      { name: "QuickBooks Online", tiers: [30, 60, 90] },
      { name: "Xero", tiers: [13, 37, 70] },
      { name: "FreshBooks", tiers: [17, 30, 55] },
      { name: "Zoho Books", tiers: [15, 40, 60] }
    ]
  },
  "Time Tracking": {
    icon: icons.time,
    tools: [
      { name: "Toggl Track", tiers: [10, 20, 30] },
      { name: "Harvest", tiers: [12, 12, 12] },
      { name: "Clockify", tiers: [0, 4.99, 9.99] },
      { name: "Timely", tiers: [9, 16, 22] },
      { name: "Hubstaff", tiers: [7, 10, 20] }
    ]
  },
  "Communication": {
    icon: icons.communication,
    tools: [
      { name: "Slack", tiers: [7.25, 12.50, 15] },
      { name: "Microsoft Teams", tiers: [6, 12.50, 22] },
      { name: "Zoom", tiers: [12.50, 16.67, 25] },
      { name: "Google Workspace", tiers: [6, 12, 18] },
      { name: "Microsoft 365", tiers: [6, 12.50, 22] }
    ]
  },
  "Automation": {
    icon: icons.automation,
    tools: [
      { name: "Zapier", tiers: [19.99, 49, 299] },
      { name: "Make", tiers: [9, 16, 29] },
      { name: "n8n", tiers: [0, 20, 50] }
    ]
  },
  "Document Management": {
    icon: icons.document,
    tools: [
      { name: "Google Drive", tiers: [6, 12, 18] },
      { name: "Dropbox", tiers: [12, 18, 24] },
      { name: "OneDrive", tiers: [6, 12.50, 22] },
      { name: "Box", tiers: [5, 15, 25] }
    ]
  },
  "E-signature": {
    icon: icons.signature,
    tools: [
      { name: "DocuSign", tiers: [10, 25, 40] },
      { name: "PandaDoc", tiers: [19, 49, 65] },
      { name: "HelloSign", tiers: [15, 25, 40] },
      { name: "SignNow", tiers: [8, 15, 25] }
    ]
  },
  "Scheduling": {
    icon: icons.calendar,
    tools: [
      { name: "Calendly", tiers: [8, 12, 16] },
      { name: "Acuity", tiers: [16, 27, 49] }
    ]
  },
  "Marketing": {
    icon: icons.marketing,
    tools: [
      { name: "Mailchimp", tiers: [13, 20, 350] },
      { name: "Constant Contact", tiers: [12, 35, 80] },
      { name: "ConvertKit", tiers: [9, 25, 50] }
    ]
  },
  "Collaboration & Wikis": {
    icon: icons.collaboration,
    tools: [
      { name: "Coda", tiers: [10, 30, 50] },
      { name: "Confluence", tiers: [5.75, 11, 22.05] },
      { name: "Guru", tiers: [5, 10, 20] },
      { name: "Slite", tiers: [8, 12.50, 15] }
    ]
  },
  "HR & Payroll": {
    icon: icons.hr,
    tools: [
      { name: "Gusto", tiers: [40, 80, 120] },
      { name: "Rippling", tiers: [8, 16, 25] }
    ]
  }
};

const wasteCategories = [
  {
    id: "ductTape",
    name: "Manual Data Entry",
    description: "Think: copying info from emails to spreadsheets, updating CRM after calls, syncing data between apps",
    defaultHours: 10,
    defaultRate: 40
  },
  {
    id: "emailArchaeology",
    name: "Searching for Info",
    description: "Think: digging through old emails to find a client's request, hunting for that attachment someone sent",
    defaultHours: 10,
    defaultRate: 40
  },
  {
    id: "spreadsheetHell",
    name: "Spreadsheet Chaos",
    description: "Think: fixing broken formulas, merging duplicate files, figuring out 'which version is the latest?'",
    defaultHours: 10,
    defaultRate: 40
  },
  {
    id: "fileHunting",
    name: "Finding Files",
    description: "Think: searching Dropbox, Google Drive, and Slack for that one document you need right now",
    defaultHours: 10,
    defaultRate: 40
  },
  {
    id: "statusMeetings",
    name: "Unnecessary Meetings",
    description: "Think: meetings just to ask 'what's the status?' because there's no shared dashboard or updates",
    defaultHours: 10,
    defaultRate: 40
  }
];

const aiAgents = [
  { id: "contextAgent", name: "Company Context Agent", description: "Instant answers to business questions", prevHours: 4, newHours: 0.5, rate: 50 },
  { id: "customerService", name: "Customer Service AI", description: "AI handles routine client inquiries", prevHours: 6, newHours: 2, rate: 50 },
  { id: "salesAssistant", name: "Sales Assistant", description: "Pre-call briefings with past quotes and history", prevHours: 5, newHours: 1, rate: 50 },
  { id: "financialInsights", name: "Financial Insights", description: "Real-time financial answers and reports", prevHours: 4, newHours: 1, rate: 50 },
  { id: "proposalGenerator", name: "Proposal Generator", description: "AI drafts proposals from templates", prevHours: 5, newHours: 1.5, rate: 50 },
  { id: "projectKickoff", name: "Project Kickoff Agent", description: "Auto-generates project setup docs", prevHours: 4, newHours: 1, rate: 50 },
  { id: "timesheetApproval", name: "Timesheet Approval Agent", description: "AI flags timesheet anomalies", prevHours: 3, newHours: 1.5, rate: 50 },
  { id: "clientOnboarding", name: "Client Onboarding Agent", description: "Automated onboarding workflow", prevHours: 4, newHours: 1, rate: 50 },
  { id: "semanticSearch", name: "Intelligent Semantic Search", description: "Natural language search across all data", prevHours: 3, newHours: 1, rate: 50 },
  { id: "meetingPrep", name: "Meeting Prep Agent", description: "AI-generated meeting briefings", prevHours: 4, newHours: 1, rate: 50 }
];

// Category groups for mobile-friendly selection
const categoryGroups = [
  {
    id: 'sales-marketing',
    name: 'Sales & Marketing',
    icon: icons.crm,
    categories: ['CRM & Sales', 'Social Media', 'Marketing', 'Form Tools']
  },
  {
    id: 'operations',
    name: 'Operations',
    icon: icons.project,
    categories: ['Project Management', 'Automation', 'Scheduling', 'Time Tracking']
  },
  {
    id: 'communication-docs',
    name: 'Communication & Docs',
    icon: icons.communication,
    categories: ['Communication', 'Document Management', 'E-signature', 'Collaboration & Wikis']
  },
  {
    id: 'finance-hr',
    name: 'Finance & Support',
    icon: icons.invoice,
    categories: ['Invoicing & Accounting', 'Support & Help Desk', 'Dashboards & BI', 'HR & Payroll']
  }
];

// ============================================
// STATE
// ============================================

let currentStep = 1;
let highestStepReached = 1;
let selectedTools = {};
let wasteInputs = {};
let selectedAIAgents = {};
let expandedCategories = new Set();

// Group & Category selection state
let selectedGroups = new Set(); // Which groups are selected
let selectedGroupSequence = []; // Array of selected group indices for navigation
let currentGroupIndex = 0; // Current group in category selection phase
let checkedCategories = new Set(); // Which categories are selected
let categorySequence = []; // Array of selected categories for tool selection
let currentCategoryIndex = 0; // Current category in tool selection phase
let toolSelectionPhase = 'groups'; // 'groups', 'categories', or 'tools'

// Waste navigation state
let currentWasteIndex = 0;

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  initializeCategorySelection();
  initializeToolData();
  initializeWasteCategories();
  initializeAIAgents();
  initializeNavigation();
  calculateTotals();

  // Hide bottom nav on Step 1 (it has its own navigation)
  document.querySelector('.nav-buttons').style.display = 'none';
});

// Initialize group and category selection
function initializeCategorySelection() {
  // Initialize group grid (checkboxes)
  initializeGroupGrid();

  // Continue from groups button - starts sequential category selection
  document.getElementById('continueFromGroupsBtn').addEventListener('click', startCategoryPhase);

  // Group navigation buttons (in category selection phase)
  document.getElementById('prevGroupBtn').addEventListener('click', () => navigateGroup(-1));
  document.getElementById('nextGroupBtn').addEventListener('click', () => navigateGroup(1));

  // Back to categories button (in tools phase)
  document.getElementById('backToCategoriesBtn').addEventListener('click', backToCategoriesPhase);

  // Category/Tool navigation buttons
  document.getElementById('prevCategoryBtn').addEventListener('click', () => navigateCategory(-1));
  document.getElementById('nextCategoryBtn').addEventListener('click', () => navigateCategory(1));
}

function initializeGroupGrid() {
  const container = document.getElementById('groupGrid');
  container.innerHTML = '';

  categoryGroups.forEach((group, index) => {
    const item = document.createElement('div');
    item.className = 'group-item' + (selectedGroups.has(index) ? ' selected' : '');
    item.dataset.groupIndex = index;

    item.innerHTML = `
      <div class="group-checkbox">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <div class="group-item-icon">${group.icon}</div>
      <div class="group-item-name">${group.name}</div>
    `;

    item.addEventListener('click', () => toggleGroupSelection(index, item));
    container.appendChild(item);
  });

  updateGroupCount();
}

function toggleGroupSelection(index, element) {
  if (selectedGroups.has(index)) {
    selectedGroups.delete(index);
    element.classList.remove('selected');
  } else {
    selectedGroups.add(index);
    element.classList.add('selected');
  }
  updateGroupCount();
}

function updateGroupCount() {
  const count = selectedGroups.size;
  const btn = document.getElementById('continueFromGroupsBtn');
  const countSpan = document.getElementById('selectedGroupCount');

  btn.disabled = count === 0;
  countSpan.textContent = count === 0 ? '(0 selected)' : count === 1 ? '(1 selected)' : `(${count} selected)`;
}

// Start sequential category selection through all selected groups
function startCategoryPhase() {
  if (selectedGroups.size === 0) return;

  // Create sequence from selected groups
  selectedGroupSequence = Array.from(selectedGroups).sort((a, b) => a - b);
  currentGroupIndex = 0;
  toolSelectionPhase = 'categories';

  // Switch phases
  document.getElementById('groupSelectionPhase').style.display = 'none';
  document.getElementById('categorySelectionPhase').style.display = 'block';

  renderCurrentGroup();
  updateHeight();
}

function renderCurrentGroup() {
  const groupIdx = selectedGroupSequence[currentGroupIndex];
  const group = categoryGroups[groupIdx];
  const total = selectedGroupSequence.length;

  // Update title and progress
  document.getElementById('groupTitle').textContent = group.name;
  document.getElementById('groupProgress').textContent = `Group ${currentGroupIndex + 1} of ${total} — Select the categories you use`;

  // Render categories for this group
  renderGroupCategories(group);

  // Update nav buttons
  const prevBtn = document.getElementById('prevGroupBtn');
  const nextBtn = document.getElementById('nextGroupBtn');

  prevBtn.disabled = false;
  prevBtn.textContent = currentGroupIndex === 0 ? '← Back to Groups' : '← Previous Group';

  if (currentGroupIndex === total - 1) {
    nextBtn.textContent = 'Continue to Tools →';
  } else {
    nextBtn.textContent = 'Next Group →';
  }
}

function navigateGroup(direction) {
  const total = selectedGroupSequence.length;
  const newIndex = currentGroupIndex + direction;

  if (newIndex < 0) {
    // Go back to group selection
    backToGroupsFromCategories();
    return;
  }

  if (newIndex >= total) {
    // Done with all groups, start tools phase
    startToolsPhase();
    return;
  }

  currentGroupIndex = newIndex;
  renderCurrentGroup();
  updateHeight();
}

function backToGroupsFromCategories() {
  toolSelectionPhase = 'groups';
  document.getElementById('categorySelectionPhase').style.display = 'none';
  document.getElementById('groupSelectionPhase').style.display = 'block';
  updateHeight();
}

function renderGroupCategories(group) {
  const container = document.getElementById('categoryCheckboxGrid');
  container.innerHTML = '';

  group.categories.forEach(category => {
    const data = toolsData[category];
    if (!data) return;

    const item = document.createElement('div');
    item.className = 'category-checkbox-item' + (checkedCategories.has(category) ? ' checked' : '');
    item.dataset.category = category;

    item.innerHTML = `
      <div class="checkbox">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <div class="category-info">
        <span class="category-icon">${data.icon}</span>
        <span class="category-label">${category}</span>
      </div>
    `;

    item.addEventListener('click', () => toggleCategorySelection(category, item));
    container.appendChild(item);
  });
}

function toggleCategorySelection(category, element) {
  if (checkedCategories.has(category)) {
    checkedCategories.delete(category);
    element.classList.remove('checked');
  } else {
    checkedCategories.add(category);
    element.classList.add('checked');
  }
}

function startToolsPhase() {
  if (checkedCategories.size === 0) {
    // No categories selected - go back to first group to select some
    currentGroupIndex = 0;
    renderCurrentGroup();
    return;
  }

  // Create sequence from checked categories in order they appear in toolsData
  categorySequence = Object.keys(toolsData).filter(cat => checkedCategories.has(cat));
  currentCategoryIndex = 0;
  toolSelectionPhase = 'tools';

  // Switch phases - hide both group and category phases
  document.getElementById('groupSelectionPhase').style.display = 'none';
  document.getElementById('categorySelectionPhase').style.display = 'none';
  document.getElementById('toolSelectionPhase').style.display = 'block';

  renderCurrentCategory();
  updateHeight();
}

function backToCategoriesPhase() {
  // Go back to category selection phase (last group)
  toolSelectionPhase = 'categories';
  currentGroupIndex = selectedGroupSequence.length - 1;
  document.getElementById('groupSelectionPhase').style.display = 'none';
  document.getElementById('categorySelectionPhase').style.display = 'block';
  document.getElementById('toolSelectionPhase').style.display = 'none';
  renderCurrentGroup();
  updateHeight();
}

function renderCurrentCategory() {
  const category = categorySequence[currentCategoryIndex];
  const data = toolsData[category];
  const total = categorySequence.length;

  // Update header
  document.getElementById('currentCategoryTitle').textContent = category;
  document.getElementById('categoryProgress').textContent = `Category ${currentCategoryIndex + 1} of ${total}`;

  // Update nav buttons
  document.getElementById('prevCategoryBtn').disabled = currentCategoryIndex === 0;
  const nextBtn = document.getElementById('nextCategoryBtn');
  if (currentCategoryIndex === total - 1) {
    nextBtn.textContent = 'Finish & Continue →';
  } else {
    nextBtn.textContent = 'Next Category →';
  }

  // Render tools
  renderSingleCategoryTools(category, data);
}

function renderSingleCategoryTools(category, data) {
  const container = document.getElementById('singleCategoryTools');
  const categoryId = category.replace(/\s+/g, '-').toLowerCase();

  container.innerHTML = `
    <div class="category-tools-list">
      ${data.tools.map(tool => {
        const toolId = `${categoryId}-${tool.name.replace(/\s+/g, '-').toLowerCase()}`;
        const toolState = selectedTools[toolId] || { selected: false, tier: 1, users: 5 };
        const isSelected = toolState.selected;
        const selectedTier = toolState.tier;
        const users = toolState.users;
        const cost = isSelected ? tool.tiers[selectedTier - 1] * users : 0;

        return `
          <div class="tool-item ${isSelected ? 'selected' : ''}" data-tool-id="${toolId}">
            <div class="tool-name-section">
              <div class="tool-checkbox ${isSelected ? 'checked' : ''}" data-tool="${toolId}"></div>
              <span class="tool-name">${tool.name}</span>
            </div>
            <div class="tier-select">
              ${tool.tiers.map((price, i) => `
                <button class="tier-btn ${selectedTier === i + 1 ? 'active' : ''}"
                        data-tool="${toolId}"
                        data-tier="${i + 1}"
                        ${!isSelected ? 'disabled' : ''}>
                  T${i + 1} $${price}
                </button>
              `).join('')}
            </div>
            <div class="user-count">
              <input type="number" class="user-count-input" value="${users}" min="1" max="1000"
                     data-tool="${toolId}" ${!isSelected ? 'disabled' : ''}>
              <span class="user-count-label">users</span>
            </div>
            <div class="tool-cost">${isSelected ? '$' + cost.toFixed(0) + '/mo' : '-'}</div>
          </div>
        `;
      }).join('')}
    </div>
  `;

  // Add event listeners for this category's tools
  addToolEventListeners(container);
}

function addToolEventListeners(container) {
  // Checkbox clicks
  container.querySelectorAll('.tool-checkbox').forEach(checkbox => {
    checkbox.addEventListener('click', (e) => {
      e.stopPropagation();
      const toolId = checkbox.dataset.tool;
      toggleTool(toolId);
      renderCurrentCategory();
      calculateTotals();
    });
  });

  // Tier button clicks
  container.querySelectorAll('.tier-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const toolId = btn.dataset.tool;
      const tier = parseInt(btn.dataset.tier);
      if (selectedTools[toolId] && selectedTools[toolId].selected) {
        selectedTools[toolId].tier = tier;
        renderCurrentCategory();
        calculateTotals();
      }
    });
  });

  // User count changes
  container.querySelectorAll('.user-count-input').forEach(input => {
    input.addEventListener('change', (e) => {
      const toolId = input.dataset.tool;
      const users = Math.max(1, Math.min(1000, parseInt(input.value) || 1));
      if (selectedTools[toolId]) {
        selectedTools[toolId].users = users;
        renderCurrentCategory();
        calculateTotals();
      }
    });
  });
}

function toggleTool(toolId) {
  if (selectedTools[toolId]) {
    selectedTools[toolId].selected = !selectedTools[toolId].selected;
  }
}

function navigateCategory(direction) {
  const newIndex = currentCategoryIndex + direction;

  if (newIndex < 0) {
    // Go back to category selection phase
    backToCategoriesPhase();
    return;
  }

  if (newIndex >= categorySequence.length) {
    // Finished all categories - go to step 2
    goToStep(2);
    return;
  }

  currentCategoryIndex = newIndex;
  renderCurrentCategory();

  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
  window.parent.postMessage({ type: 'scrollToTop' }, '*');

  updateHeight();
}

// Initialize tool data without rendering (old initializeToolCategories data setup)
function initializeToolData() {
  Object.entries(toolsData).forEach(([category, data]) => {
    const categoryId = category.replace(/\s+/g, '-').toLowerCase();
    data.tools.forEach(tool => {
      const toolId = `${categoryId}-${tool.name.replace(/\s+/g, '-').toLowerCase()}`;
      if (!selectedTools[toolId]) {
        selectedTools[toolId] = {
          category: category,
          name: tool.name,
          tiers: tool.tiers,
          selected: false,
          tier: 1,
          users: 5
        };
      }
    });
  });
}

// LEGACY: Keep for reference but no longer used
function initializeToolCategories() {
  const container = document.getElementById('toolCategories');
  if (!container) return;
  container.innerHTML = '';

  Object.entries(toolsData).forEach(([category, data]) => {
    const categoryId = category.replace(/\s+/g, '-').toLowerCase();

    const section = document.createElement('div');
    section.className = `category-section${expandedCategories.has(categoryId) ? ' expanded' : ''}`;
    section.id = `category-${categoryId}`;

    const selectedCount = Object.values(selectedTools)
      .filter(t => t.category === category && t.selected).length;

    section.innerHTML = `
      <div class="category-header">
        <div class="category-title">
          <span class="category-icon">${data.icon}</span>
          <span>${category}</span>
          ${selectedCount > 0 ? `<span class="category-badge">${selectedCount} selected</span>` : ''}
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <span class="category-cost" id="cost-${categoryId}">$0/mo</span>
          <span class="category-chevron">▼</span>
        </div>
      </div>
      <div class="category-tools">
        ${data.tools.map(tool => {
          const toolId = `${categoryId}-${tool.name.replace(/\s+/g, '-').toLowerCase()}`;
          const toolState = selectedTools[toolId] || { selected: false, tier: 1, users: 5 };
          const isSelected = toolState.selected;
          const selectedTier = toolState.tier;
          const users = toolState.users;
          const cost = isSelected ? tool.tiers[selectedTier - 1] * users : 0;

          return `
            <div class="tool-item ${isSelected ? 'selected' : ''}" data-tool-id="${toolId}">
              <div class="tool-name-section">
                <div class="tool-checkbox ${isSelected ? 'checked' : ''}" data-tool="${toolId}"></div>
                <span class="tool-name">${tool.name}</span>
              </div>
              <div class="tier-select">
                ${tool.tiers.map((price, i) => `
                  <button class="tier-btn ${selectedTier === i + 1 ? 'active' : ''}"
                          data-tool="${toolId}"
                          data-tier="${i + 1}"
                          ${!isSelected ? 'disabled' : ''}>
                    T${i + 1} $${price}
                  </button>
                `).join('')}
              </div>
              <div class="user-count">
                <input type="number" class="user-count-input" value="${users}" min="1" max="1000"
                       data-tool="${toolId}" ${!isSelected ? 'disabled' : ''}>
                <span class="user-count-label">users</span>
              </div>
              <div class="tool-cost">${isSelected ? '$' + cost.toFixed(0) + '/mo' : '-'}</div>
            </div>
          `;
        }).join('')}
      </div>
    `;

    // Store tool data for calculations
    data.tools.forEach(tool => {
      const toolId = `${categoryId}-${tool.name.replace(/\s+/g, '-').toLowerCase()}`;
      if (!selectedTools[toolId]) {
        selectedTools[toolId] = {
          category: category,
          name: tool.name,
          tiers: tool.tiers,
          selected: false,
          tier: 1,
          users: 5
        };
      }
    });

    container.appendChild(section);
  });

  // Add event listeners
  document.querySelectorAll('.category-header').forEach(header => {
    header.addEventListener('click', () => {
      const section = header.parentElement;
      const categoryId = section.id.replace('category-', '');
      if (expandedCategories.has(categoryId)) {
        expandedCategories.delete(categoryId);
        section.classList.remove('expanded');
      } else {
        expandedCategories.add(categoryId);
        section.classList.add('expanded');
      }
    });
  });

  document.querySelectorAll('.tool-checkbox').forEach(checkbox => {
    checkbox.addEventListener('click', (e) => {
      e.stopPropagation();
      const toolId = checkbox.dataset.tool;
      selectedTools[toolId].selected = !selectedTools[toolId].selected;
      initializeToolCategories();
      calculateTotals();
    });
  });

  document.querySelectorAll('.tier-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const toolId = btn.dataset.tool;
      const tier = parseInt(btn.dataset.tier);
      selectedTools[toolId].tier = tier;
      initializeToolCategories();
      calculateTotals();
    });
  });

  document.querySelectorAll('.user-count-input').forEach(input => {
    input.addEventListener('change', (e) => {
      const toolId = input.dataset.tool;
      selectedTools[toolId].users = parseInt(input.value) || 1;
      initializeToolCategories();
      calculateTotals();
    });
    input.addEventListener('click', (e) => e.stopPropagation());
  });

  // Update category costs
  Object.entries(toolsData).forEach(([category, data]) => {
    const categoryId = category.replace(/\s+/g, '-').toLowerCase();
    let categoryCost = 0;
    data.tools.forEach(tool => {
      const toolId = `${categoryId}-${tool.name.replace(/\s+/g, '-').toLowerCase()}`;
      const toolState = selectedTools[toolId];
      if (toolState && toolState.selected) {
        categoryCost += tool.tiers[toolState.tier - 1] * toolState.users;
      }
    });
    const costEl = document.getElementById(`cost-${categoryId}`);
    if (costEl) {
      costEl.textContent = categoryCost > 0 ? `$${formatNumber(categoryCost)}/mo` : '$0/mo';
    }
  });
}

function initializeWasteCategories() {
  // Initialize waste data
  wasteCategories.forEach(waste => {
    if (!wasteInputs[waste.id]) {
      wasteInputs[waste.id] = {
        hours: waste.defaultHours,
        rate: waste.defaultRate
      };
    }
  });

  // Add navigation event listeners
  document.getElementById('prevWasteBtn').addEventListener('click', () => navigateWaste(-1));
  document.getElementById('nextWasteBtn').addEventListener('click', () => navigateWaste(1));
}

function renderCurrentWaste() {
  const waste = wasteCategories[currentWasteIndex];
  const total = wasteCategories.length;

  // Update header
  document.getElementById('currentWasteTitle').textContent = waste.name;
  document.getElementById('wasteProgress').textContent = `Inefficiency ${currentWasteIndex + 1} of ${total}`;

  // Update nav buttons
  const prevBtn = document.getElementById('prevWasteBtn');
  prevBtn.disabled = false;
  prevBtn.textContent = currentWasteIndex === 0 ? '← Back to Tools' : '← Previous';

  const nextBtn = document.getElementById('nextWasteBtn');
  if (currentWasteIndex === total - 1) {
    nextBtn.textContent = 'Finish & Continue →';
  } else {
    nextBtn.textContent = 'Next →';
  }

  // Render the waste item
  const container = document.getElementById('singleWasteItem');
  const cost = wasteInputs[waste.id].hours * wasteInputs[waste.id].rate * 4;

  container.innerHTML = `
    <div class="waste-item">
      <div class="waste-header">
        <div>
          <div class="waste-description">${waste.description}</div>
        </div>
        <div class="waste-cost" id="waste-cost-${waste.id}">$${formatNumber(cost)}/mo</div>
      </div>
      <div class="waste-inputs">
        <div class="input-group">
          <label class="input-label">Hours per week (team-wide)</label>
          <div class="slider-wrapper">
            <input type="range" class="slider" min="0" max="80" value="${wasteInputs[waste.id].hours}"
                   data-waste="${waste.id}" data-type="hours">
            <div class="slider-value">${wasteInputs[waste.id].hours}h</div>
          </div>
        </div>
        <div class="input-group">
          <label class="input-label">Hourly labor rate ($)</label>
          <div class="slider-wrapper">
            <input type="range" class="slider" min="20" max="150" value="${wasteInputs[waste.id].rate}"
                   data-waste="${waste.id}" data-type="rate">
            <div class="slider-value">$${wasteInputs[waste.id].rate}</div>
          </div>
        </div>
      </div>
    </div>
  `;

  // Add event listeners for sliders
  container.querySelectorAll('.slider').forEach(slider => {
    slider.addEventListener('input', (e) => {
      const wasteId = slider.dataset.waste;
      const type = slider.dataset.type;
      wasteInputs[wasteId][type] = parseInt(slider.value);

      // Update display
      const valueDisplay = slider.nextElementSibling;
      if (type === 'hours') {
        valueDisplay.textContent = slider.value + 'h';
      } else {
        valueDisplay.textContent = '$' + slider.value;
      }

      // Update cost
      const cost = wasteInputs[wasteId].hours * wasteInputs[wasteId].rate * 4;
      document.getElementById(`waste-cost-${wasteId}`).textContent = '$' + formatNumber(cost) + '/mo';

      calculateTotals();
    });
  });
}

function navigateWaste(direction) {
  const newIndex = currentWasteIndex + direction;

  if (newIndex < 0) {
    // Go back to Step 1 - position at last category
    currentCategoryIndex = categorySequence.length - 1;
    goToStep(1);
    return;
  }

  if (newIndex >= wasteCategories.length) {
    // Finished all waste items - go to Step 3
    goToStep(3);
    return;
  }

  currentWasteIndex = newIndex;
  renderCurrentWaste();

  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
  window.parent.postMessage({ type: 'scrollToTop' }, '*');

  updateHeight();
}

function initializeAIAgents() {
  // AI step is now informational only - update the recovery percentage
  updateAIRecoveryPercent();
}

function updateAIRecoveryPercent() {
  // Calculate total waste hours per week
  let totalWasteHours = 0;
  Object.values(wasteInputs).forEach(input => {
    totalWasteHours += input.hours || 0;
  });

  // Dynamic recovery percentage based on waste level
  // Formula: base 25% + (hours/100 * 35%), capped at 60%
  let recoveryNum = Math.min(60, 25 + (totalWasteHours / 100) * 35);
  recoveryNum = Math.round(recoveryNum / 5) * 5; // Round to nearest 5

  const el = document.getElementById('aiRecoveryPercent');
  if (el) {
    el.textContent = '~' + recoveryNum + '%';
  }
}

function updateResultsPage() {
  const { toolsCost, wasteCost, aiCost, totalWaste } = calculateTotals();
  const yearlyWaste = totalWaste * 12;

  // Update results hero
  document.getElementById('resultsYearlyWaste').textContent = '$' + formatNumber(yearlyWaste);

  // Update results cards
  document.getElementById('resultsToolsCost').textContent = '$' + formatNumber(toolsCost) + '/mo';
  document.getElementById('resultsWasteCost').textContent = '$' + formatNumber(wasteCost) + '/mo';

  // Draw results chart
  drawResultsChart(totalWaste);
}

function updateCTAPage() {
  const { toolsCost, wasteCost, aiCost, totalWaste } = calculateTotals();
  const yearlyWaste = totalWaste * 12;

  // Update CTA stats
  document.getElementById('ctaMonthlyWaste').textContent = '$' + formatNumber(totalWaste);
  document.getElementById('ctaYearlyWaste').textContent = '$' + formatNumber(yearlyWaste);
  document.getElementById('ctaUrgencyAmount').textContent = '$' + formatNumber(totalWaste);
}

function drawResultsChart(monthlyWaste) {
  const canvas = document.getElementById('resultsChart');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width - 48;
  canvas.height = 280;

  const width = canvas.width;
  const height = canvas.height;
  const padding = { top: 40, right: 40, bottom: 40, left: 70 };
  const chartWidth = width - padding.left - padding.right;
  const chartHeight = height - padding.top - padding.bottom;

  // Generate 12-month data
  const data = [];
  for (let month = 0; month <= 12; month++) {
    data.push({ month, value: monthlyWaste * month });
  }

  const maxValue = monthlyWaste * 12;
  const yScale = chartHeight / maxValue;
  const xScale = chartWidth / 12;

  // Clear canvas
  ctx.clearRect(0, 0, width, height);

  // Draw grid
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;

  for (let i = 0; i <= 4; i++) {
    const y = padding.top + (chartHeight / 4) * i;
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(width - padding.right, y);
    ctx.stroke();

    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.font = '11px DM Sans';
    ctx.textAlign = 'right';
    const value = maxValue - (maxValue / 4) * i;
    ctx.fillText('$' + formatNumber(value), padding.left - 10, y + 4);
  }

  // X-axis labels
  ctx.textAlign = 'center';
  for (let month = 0; month <= 12; month += 3) {
    const x = padding.left + month * xScale;
    ctx.fillText('M' + month, x, height - 15);
  }

  // Draw area fill
  ctx.beginPath();
  ctx.moveTo(padding.left, padding.top + chartHeight);
  data.forEach((point) => {
    const x = padding.left + point.month * xScale;
    const y = padding.top + chartHeight - (point.value * yScale);
    ctx.lineTo(x, y);
  });
  ctx.lineTo(padding.left + 12 * xScale, padding.top + chartHeight);
  ctx.closePath();
  ctx.fillStyle = 'rgba(255, 107, 107, 0.2)';
  ctx.fill();

  // Draw line
  ctx.beginPath();
  ctx.strokeStyle = '#ff6b6b';
  ctx.lineWidth = 3;
  data.forEach((point, i) => {
    const x = padding.left + point.month * xScale;
    const y = padding.top + chartHeight - (point.value * yScale);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // End point
  const endX = padding.left + 12 * xScale;
  const endY = padding.top + chartHeight - (maxValue * yScale);
  ctx.beginPath();
  ctx.arc(endX, endY, 6, 0, Math.PI * 2);
  ctx.fillStyle = '#ff6b6b';
  ctx.fill();

  // Label
  ctx.fillStyle = '#ff6b6b';
  ctx.font = 'bold 12px DM Sans';
  ctx.textAlign = 'center';
  ctx.fillText('$' + formatNumber(maxValue), endX, endY - 15);
}

function initializeNavigation() {
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  prevBtn.addEventListener('click', () => {
    // Handle Step 1 phases
    if (currentStep === 1 && toolSelectionPhase === 'tools') {
      // Go to previous category or back to category selection
      if (currentCategoryIndex > 0) {
        navigateCategory(-1);
      } else {
        backToCategoriesPhase();
      }
      return;
    }

    if (currentStep > 1) {
      goToStep(currentStep - 1);
    }
  });

  nextBtn.addEventListener('click', () => {
    // Handle Step 5 restart
    if (currentStep === 5) {
      // Reset everything and go to step 1
      resetCalculator();
      return;
    }

    // Handle Step 1 phases
    if (currentStep === 1) {
      if (toolSelectionPhase === 'categories') {
        // Need to select categories first
        if (checkedCategories.size > 0) {
          startToolsPhase();
        }
        return;
      } else {
        // In tools phase - go to next category or step 2
        navigateCategory(1);
        return;
      }
    }

    if (currentStep < 5) {
      goToStep(currentStep + 1);
    }
  });

  // Step indicators click
  document.querySelectorAll('.step-indicator').forEach(indicator => {
    indicator.addEventListener('click', () => {
      const step = parseInt(indicator.dataset.step);
      // Only allow navigation to completed steps or current step
      if (step <= highestStepReached) {
        goToStep(step);
      }
    });
  });
}

function resetCalculator() {
  // Reset all state
  currentStep = 1;
  highestStepReached = 1;
  selectedTools = {};
  selectedGroups = new Set();
  selectedGroupSequence = [];
  currentGroupIndex = 0;
  checkedCategories = new Set();
  categorySequence = [];
  currentCategoryIndex = 0;
  toolSelectionPhase = 'groups';
  currentWasteIndex = 0;

  // Reset waste inputs
  Object.keys(wasteInputs).forEach(key => {
    wasteInputs[key] = { hours: 10, rate: 50 };
  });

  // Reset AI agents
  Object.keys(selectedAIAgents).forEach(key => {
    selectedAIAgents[key] = false;
  });

  // Re-initialize
  initializeCategorySelection();
  initializeToolData();
  initializeWasteCategories();
  initializeAIAgents();

  // Show group selection phase (initial state)
  document.getElementById('groupSelectionPhase').style.display = 'block';
  document.getElementById('categorySelectionPhase').style.display = 'none';
  document.getElementById('toolSelectionPhase').style.display = 'none';

  // Hide bottom nav (Step 1 has its own navigation)
  document.querySelector('.nav-buttons').style.display = 'none';

  goToStep(1);
  calculateTotals();
}

function goToStep(step) {
  currentStep = step;

  // Track highest step reached
  if (step > highestStepReached) {
    highestStepReached = step;
  }

  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach(indicator => {
    const indicatorStep = parseInt(indicator.dataset.step);
    indicator.classList.remove('active', 'completed', 'locked');
    if (indicatorStep === currentStep) {
      indicator.classList.add('active');
    } else if (indicatorStep <= highestStepReached) {
      indicator.classList.add('completed');
    } else {
      indicator.classList.add('locked');
    }
  });

  // Update step content
  document.querySelectorAll('.step-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(`step${currentStep}`).classList.add('active');

  // Handle Step 1 phases when returning
  if (currentStep === 1) {
    if (checkedCategories.size > 0 && toolSelectionPhase === 'tools') {
      // Return to tools phase, show last category they were on
      document.getElementById('groupSelectionPhase').style.display = 'none';
      document.getElementById('categorySelectionPhase').style.display = 'none';
      document.getElementById('toolSelectionPhase').style.display = 'block';
      renderCurrentCategory();
    } else if (toolSelectionPhase === 'categories' && selectedGroupSequence.length > 0) {
      // Return to category selection phase
      document.getElementById('groupSelectionPhase').style.display = 'none';
      document.getElementById('categorySelectionPhase').style.display = 'block';
      document.getElementById('toolSelectionPhase').style.display = 'none';
      renderCurrentGroup();
    } else {
      // Show group selection (initial state)
      document.getElementById('groupSelectionPhase').style.display = 'block';
      document.getElementById('categorySelectionPhase').style.display = 'none';
      document.getElementById('toolSelectionPhase').style.display = 'none';
      initializeGroupGrid();
    }
  }

  // Handle Step 2 - render current waste item
  if (currentStep === 2) {
    renderCurrentWaste();
  }

  // Hide bottom nav buttons on Step 1 & 2 (they have their own navigation)
  const navButtons = document.querySelector('.nav-buttons');
  if (currentStep === 1 || currentStep === 2) {
    navButtons.style.display = 'none';
  } else {
    navButtons.style.display = 'flex';
    document.getElementById('prevBtn').disabled = false;
    document.getElementById('nextBtn').textContent = currentStep === 5 ? 'Start Over' : 'Next Step';
  }

  if (currentStep === 3) {
    updateAIRecoveryPercent();
  }

  if (currentStep === 4) {
    updateResultsPage();
  }

  if (currentStep === 5) {
    updateCTAPage();
    document.getElementById('nextBtn').textContent = 'Start Over';
  }

  // Update height for iframe - reset and recalculate after DOM updates
  lastSentHeight = 0;
  setTimeout(updateHeight, 50);

  // Scroll to top - both inside iframe and tell parent
  // Internal scroll for mobile fallback
  window.scrollTo({ top: 0, behavior: 'smooth' });
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;

  // Tell parent to scroll to top of iframe
  window.parent.postMessage({ type: 'scrollToTop' }, '*');
}

// ============================================
// CALCULATIONS
// ============================================

function calculateTotals() {
  // Calculate SaaS tools cost
  let toolsCost = 0;
  Object.values(selectedTools).forEach(tool => {
    if (tool.selected) {
      toolsCost += tool.tiers[tool.tier - 1] * tool.users;
    }
  });

  // Calculate inefficiency waste
  let wasteCost = 0;
  let wasteHours = 0;
  Object.values(wasteInputs).forEach(waste => {
    wasteCost += waste.hours * waste.rate * 4; // Monthly
    wasteHours += waste.hours; // Weekly hours
  });

  // AI cost is now estimated as percentage of waste cost (for results page)
  const aiCost = wasteCost * 0.4; // Estimate 40% recovery

  const totalWaste = toolsCost + wasteCost; // Net Waste = SaaS + Inefficiency only

  // Update running totals
  document.getElementById('runningToolsCost').textContent = '$' + formatNumber(toolsCost);
  document.getElementById('runningWasteCost').textContent = '$' + formatNumber(wasteCost);
  document.getElementById('runningWasteHours').textContent = wasteHours + 'h';
  document.getElementById('runningTotalWaste').textContent = '$' + formatNumber(totalWaste);

  return { toolsCost, wasteCost, aiCost, totalWaste, wasteHours };
}


// ============================================
// UTILITIES
// ============================================

function formatNumber(num) {
  return Math.round(num).toLocaleString('en-US');
}

// Height communication for iframe
let lastSentHeight = 0;
let heightUpdateTimeout = null;
let isUpdatingHeight = false;

function updateHeight() {
  // Prevent re-entry during height calculation
  if (isUpdatingHeight) return;
  isUpdatingHeight = true;

  try {
    const container = document.querySelector('.calculator-container');
    if (!container) {
      isUpdatingHeight = false;
      return;
    }

    // Calculate height based on actual content elements, not scroll/offset heights
    // This prevents feedback loops with the parent iframe
    const rect = container.getBoundingClientRect();
    const computedStyle = window.getComputedStyle(container);
    const marginBottom = parseInt(computedStyle.marginBottom) || 0;
    const marginTop = parseInt(computedStyle.marginTop) || 0;

    // Use the container's bounding rect which gives actual rendered size
    let height = rect.height + marginTop + marginBottom + 48;

    // Cap at reasonable maximum to prevent infinite expansion
    const MAX_HEIGHT = 3000;
    height = Math.min(height, MAX_HEIGHT);

    // Only send if significantly different (prevents micro-updates)
    if (Math.abs(height - lastSentHeight) < 20) {
      isUpdatingHeight = false;
      return;
    }

    lastSentHeight = height;
    window.parent.postMessage({ type: 'resize', height: height }, '*');
  } catch (error) {
    console.log('PostMessage not available:', error);
  }

  isUpdatingHeight = false;
}

function updateHeightDelayed() {
  if (heightUpdateTimeout) clearTimeout(heightUpdateTimeout);
  heightUpdateTimeout = setTimeout(updateHeight, 150);
}

// Send height after initial render settles
setTimeout(updateHeight, 100);
setTimeout(updateHeight, 300);

window.addEventListener('load', function() {
  setTimeout(updateHeight, 150);
});

// Only observe specific content changes, not style changes that could cause loops
const observer = new MutationObserver(function(mutations) {
  // Filter out style-only changes to prevent feedback loops
  const hasContentChange = mutations.some(m =>
    m.type === 'childList' ||
    (m.type === 'attributes' && m.attributeName === 'class')
  );
  if (hasContentChange) {
    updateHeightDelayed();
  }
});
observer.observe(document.body, {
  childList: true,
  subtree: true,
  attributes: true,
  attributeFilter: ['class']
});
</script>
</body>
</html>
