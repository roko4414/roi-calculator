<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APG ROI Calculator</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }

    body {
      color: white;
      background-color: #0a0a0a;
      min-height: 100vh;
    }

    /* Container */
    .calculator-container {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .calculator-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .calculator-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .calculator-header p {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .step-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 24px;
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .step-indicator:hover {
      background: rgba(255,255,255,0.08);
    }

    .step-indicator.active {
      background: rgba(125, 255, 0, 0.15);
      color: #7DFF00;
      border-color: rgba(125, 255, 0, 0.3);
    }

    .step-indicator.completed {
      background: rgba(125, 255, 0, 0.1);
      color: #7DFF00;
    }

    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
    }

    .step-indicator.active .step-number,
    .step-indicator.completed .step-number {
      background: #7DFF00;
      color: #0a0a0a;
    }

    /* Panel */
    .panel {
      background: rgba(20, 20, 20, 0.9);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .panel-title {
      font-size: 20px;
      font-weight: 600;
    }

    .panel-subtitle {
      color: rgba(255,255,255,0.5);
      font-size: 14px;
      margin-top: 4px;
    }

    /* Step Content */
    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    /* Category Sections */
    .category-section {
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      overflow: hidden;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .category-header:hover {
      background: rgba(255,255,255,0.05);
    }

    .category-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 15px;
    }

    .category-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(125, 255, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7DFF00;
    }

    .category-icon svg {
      width: 18px;
      height: 18px;
    }

    .category-badge {
      background: rgba(125, 255, 0, 0.2);
      color: #7DFF00;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .category-chevron {
      color: rgba(255,255,255,0.4);
      transition: transform 0.2s ease;
    }

    .category-section.expanded .category-chevron {
      transform: rotate(180deg);
    }

    .category-tools {
      display: none;
      padding: 16px;
      background: rgba(0,0,0,0.2);
    }

    .category-section.expanded .category-tools {
      display: block;
    }

    /* Tool Items */
    .tool-item {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 12px;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.02);
      transition: background 0.2s ease;
    }

    .tool-item:hover {
      background: rgba(255,255,255,0.05);
    }

    .tool-item:last-child {
      margin-bottom: 0;
    }

    .tool-name-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tool-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .tool-checkbox.checked {
      background: #7DFF00;
      border-color: #7DFF00;
    }

    .tool-checkbox.checked::after {
      content: "✓";
      color: #0a0a0a;
      font-weight: 700;
      font-size: 12px;
    }

    .tool-name {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }

    .tool-item.selected .tool-name {
      color: white;
    }

    /* Tier Select */
    .tier-select {
      display: flex;
      gap: 4px;
    }

    .tier-btn {
      padding: 6px 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: transparent;
      color: rgba(255,255,255,0.5);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .tier-btn:hover {
      border-color: rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.8);
    }

    .tier-btn.active {
      background: #7DFF00;
      border-color: #7DFF00;
      color: #0a0a0a;
      font-weight: 600;
    }

    .tier-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* User Count Input */
    .user-count {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-count-input {
      width: 60px;
      padding: 6px 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.3);
      color: white;
      border-radius: 6px;
      font-size: 13px;
      text-align: center;
    }

    .user-count-input:focus {
      outline: none;
      border-color: #7DFF00;
    }

    .user-count-label {
      font-size: 12px;
      color: rgba(255,255,255,0.4);
    }

    /* Tool Cost Display */
    .tool-cost {
      font-size: 13px;
      color: #7DFF00;
      font-weight: 600;
      min-width: 80px;
      text-align: right;
    }

    /* Waste Category */
    .waste-item {
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .waste-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .waste-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .waste-description {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      max-width: 400px;
    }

    .waste-cost {
      font-size: 18px;
      font-weight: 700;
      color: #7DFF00;
    }

    .waste-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-label {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      font-weight: 500;
    }

    .slider-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #7DFF00;
      cursor: pointer;
      border: 2px solid rgba(0,0,0,0.2);
    }

    .slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #7DFF00;
      cursor: pointer;
      border: 2px solid rgba(0,0,0,0.2);
    }

    .slider-value {
      min-width: 50px;
      padding: 6px 10px;
      background: rgba(125, 255, 0, 0.15);
      color: #7DFF00;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }

    /* AI Agent Items */
    .ai-agent-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 16px;
      align-items: center;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .ai-toggle {
      width: 44px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      transition: background 0.2s ease;
    }

    .ai-toggle.active {
      background: #7DFF00;
    }

    .ai-toggle::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s ease;
    }

    .ai-toggle.active::after {
      transform: translateX(20px);
      background: #0a0a0a;
    }

    .ai-info h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .ai-info p {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }

    .ai-savings {
      text-align: right;
    }

    .ai-savings-amount {
      font-size: 16px;
      font-weight: 700;
      color: #7DFF00;
    }

    .ai-savings-label {
      font-size: 11px;
      color: rgba(255,255,255,0.4);
    }

    /* APG Tier Selection */
    .tier-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .tier-cards {
        grid-template-columns: 1fr;
      }
    }

    .tier-card {
      padding: 24px;
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .tier-card:hover {
      border-color: rgba(125, 255, 0, 0.3);
      background: rgba(255,255,255,0.05);
    }

    .tier-card.selected {
      border-color: #7DFF00;
      background: rgba(125, 255, 0, 0.1);
    }

    .tier-card-badge {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .tier-card.selected .tier-card-badge {
      background: #7DFF00;
      color: #0a0a0a;
    }

    .tier-card-price {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .tier-card-subtitle {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 16px;
    }

    .tier-card-maintenance {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    /* Summary Dashboard */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 640px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-card {
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .summary-card-label {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 8px;
    }

    .summary-card-value {
      font-size: 28px;
      font-weight: 700;
    }

    .summary-card-value.green {
      color: #7DFF00;
    }

    .summary-card-value.red {
      color: #ff6b6b;
    }

    .summary-card-subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.4);
      margin-top: 4px;
    }

    /* Chart Container */
    .chart-container {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    #roiChart {
      width: 100%;
      height: 340px;
    }

    /* Breakdown */
    .breakdown-section {
      margin-top: 24px;
    }

    .breakdown-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .breakdown-item:last-child {
      border-bottom: none;
    }

    .breakdown-label {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }

    .breakdown-value {
      font-size: 14px;
      font-weight: 600;
    }

    .breakdown-value.negative {
      color: #ff6b6b;
    }

    .breakdown-value.positive {
      color: #7DFF00;
    }

    /* Navigation Buttons */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-top: 24px;
    }

    .nav-btn {
      padding: 14px 32px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .nav-btn.secondary {
      background: rgba(255,255,255,0.08);
      color: white;
    }

    .nav-btn.secondary:hover {
      background: rgba(255,255,255,0.12);
    }

    .nav-btn.primary {
      background: #7DFF00;
      color: #0a0a0a;
    }

    .nav-btn.primary:hover {
      background: #6ee600;
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Running Total Bar */
    .running-total {
      position: sticky;
      bottom: 0;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 16px 24px;
      margin: 0 -24px -24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .running-total-item {
      text-align: center;
    }

    .running-total-label {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 4px;
    }

    .running-total-value {
      font-size: 18px;
      font-weight: 700;
      color: #7DFF00;
    }

    .running-total-value.red {
      color: #ff6b6b;
    }

    /* Responsive adjustments */
    @media (max-width: 640px) {
      .tool-item {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .tier-select {
        justify-content: flex-start;
      }

      .waste-inputs {
        grid-template-columns: 1fr;
      }

      .progress-steps {
        gap: 4px;
      }

      .step-indicator {
        padding: 6px 10px;
        font-size: 11px;
      }

      .step-indicator .step-label {
        display: none;
      }
    }

    /* Category Cost Summary */
    .category-cost {
      font-size: 14px;
      color: #7DFF00;
      font-weight: 600;
    }
  </style>
</head>
<body>
<div class="calculator-container">
  <div class="calculator-header">
    <h1>APG ROI Calculator</h1>
    <p>Calculate your potential savings with a custom APG solution</p>
  </div>

  <!-- Progress Steps -->
  <div class="progress-steps">
    <div class="step-indicator active" data-step="1">
      <span class="step-number">1</span>
      <span class="step-label">SaaS Tools</span>
    </div>
    <div class="step-indicator" data-step="2">
      <span class="step-number">2</span>
      <span class="step-label">Inefficiencies</span>
    </div>
    <div class="step-indicator" data-step="3">
      <span class="step-number">3</span>
      <span class="step-label">AI Enablement</span>
    </div>
    <div class="step-indicator" data-step="4">
      <span class="step-number">4</span>
      <span class="step-label">APG Investment</span>
    </div>
    <div class="step-indicator" data-step="5">
      <span class="step-number">5</span>
      <span class="step-label">Summary</span>
    </div>
  </div>

  <!-- Step 1: SaaS Tools -->
  <div class="step-content active" id="step1">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">Current SaaS Tools</h2>
          <p class="panel-subtitle">Select the tools your team currently uses and specify pricing tier & users</p>
        </div>
      </div>
      <div id="toolCategories"></div>
    </div>
  </div>

  <!-- Step 2: Inefficiency Waste -->
  <div class="step-content" id="step2">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">Inefficiency Waste</h2>
          <p class="panel-subtitle">Estimate hours your team spends on these inefficient activities</p>
        </div>
      </div>
      <div id="wasteCategories"></div>
    </div>
  </div>

  <!-- Step 3: AI Enablement -->
  <div class="step-content" id="step3">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">AI Enablement Opportunities</h2>
          <p class="panel-subtitle">Select AI agents that could help automate your workflows</p>
        </div>
      </div>
      <div id="aiAgents"></div>
    </div>
  </div>

  <!-- Step 4: APG Investment -->
  <div class="step-content" id="step4">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">Select Your APG Tier</h2>
          <p class="panel-subtitle">Choose the investment level that matches your needs</p>
        </div>
      </div>
      <div class="tier-cards" id="tierCards">
        <div class="tier-card" data-tier="1">
          <div class="tier-card-badge">Tier 1</div>
          <div class="tier-card-price">$65,000</div>
          <div class="tier-card-subtitle">One-time investment</div>
          <div class="tier-card-maintenance">+ $999/mo maintenance<br><small>(starts month 7)</small></div>
        </div>
        <div class="tier-card" data-tier="2">
          <div class="tier-card-badge">Tier 2</div>
          <div class="tier-card-price">$95,000</div>
          <div class="tier-card-subtitle">One-time investment</div>
          <div class="tier-card-maintenance">+ $999/mo maintenance<br><small>(starts month 7)</small></div>
        </div>
        <div class="tier-card selected" data-tier="3">
          <div class="tier-card-badge">Tier 3</div>
          <div class="tier-card-price">$125,000</div>
          <div class="tier-card-subtitle">One-time investment</div>
          <div class="tier-card-maintenance">+ $999/mo maintenance<br><small>(starts month 7)</small></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 5: Summary -->
  <div class="step-content" id="step5">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">Your ROI Summary</h2>
          <p class="panel-subtitle">Based on your inputs, here's your potential return on investment</p>
        </div>
      </div>

      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-card-label">Total Monthly Waste</div>
          <div class="summary-card-value red" id="summaryMonthlyWaste">$0</div>
          <div class="summary-card-subtitle">SaaS + Inefficiency + AI Opportunity</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-label">Annual Waste (Year 1)</div>
          <div class="summary-card-value red" id="summaryAnnualWaste">$0</div>
          <div class="summary-card-subtitle">Without APG solution</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-label">APG Investment</div>
          <div class="summary-card-value" id="summaryInvestment">$125,000</div>
          <div class="summary-card-subtitle">One-time + Year 1 maintenance</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-label">Break-Even Point</div>
          <div class="summary-card-value green" id="summaryBreakeven">Month 4</div>
          <div class="summary-card-subtitle">When savings exceed investment</div>
        </div>
      </div>

      <div class="chart-container">
        <h3 class="chart-title">36-Month ROI Projection</h3>
        <canvas id="roiChart"></canvas>
      </div>

      <div class="breakdown-section">
        <h3 class="breakdown-title">Cost Breakdown</h3>
        <div id="costBreakdown"></div>
      </div>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="nav-buttons">
    <button class="nav-btn secondary" id="prevBtn" disabled>Back</button>
    <button class="nav-btn primary" id="nextBtn">Next Step</button>
  </div>

  <!-- Running Total -->
  <div class="running-total">
    <div class="running-total-item">
      <div class="running-total-label">SaaS Cost/mo</div>
      <div class="running-total-value red" id="runningToolsCost">$0</div>
    </div>
    <div class="running-total-item">
      <div class="running-total-label">Inefficiency/mo</div>
      <div class="running-total-value red" id="runningWasteCost">$0</div>
    </div>
    <div class="running-total-item">
      <div class="running-total-label">AI Savings/mo</div>
      <div class="running-total-value" id="runningAICost">$0</div>
    </div>
    <div class="running-total-item">
      <div class="running-total-label">Total Waste/mo</div>
      <div class="running-total-value red" id="runningTotalWaste">$0</div>
    </div>
  </div>
</div>

<script>
// ============================================
// DATA
// ============================================

// SVG Icons
const icons = {
  crm: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
  project: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>`,
  form: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
  social: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>`,
  dashboard: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>`,
  support: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>`,
  invoice: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
  time: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
  communication: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
  automation: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
  document: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`,
  signature: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`,
  calendar: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
  marketing: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>`,
  collaboration: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
  hr: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>`
};

const toolsData = {
  "CRM & Sales": {
    icon: icons.crm,
    tools: [
      { name: "HubSpot", tiers: [15, 50, 125] },
      { name: "Salesforce", tiers: [25, 75, 150] },
      { name: "Pipedrive", tiers: [14, 29, 49] },
      { name: "Zoho CRM", tiers: [14, 23, 40] },
      { name: "Copper", tiers: [29, 69, 134] },
      { name: "Close", tiers: [29, 69, 129] },
      { name: "Monday Sales CRM", tiers: [12, 17, 28] }
    ]
  },
  "Project Management": {
    icon: icons.project,
    tools: [
      { name: "Asana", tiers: [10.99, 24.99, 50] },
      { name: "Monday.com", tiers: [9, 12, 19] },
      { name: "ClickUp", tiers: [7, 12, 19] },
      { name: "Trello", tiers: [5, 10, 17.50] },
      { name: "Wrike", tiers: [9.80, 24.80, 50] },
      { name: "Smartsheet", tiers: [9, 19, 39] }
    ]
  },
  "Form Tools": {
    icon: icons.form,
    tools: [
      { name: "Typeform", tiers: [25, 50, 83] },
      { name: "Jotform", tiers: [34, 39, 99] },
      { name: "Wufoo", tiers: [14, 29, 74] },
      { name: "Cognito Forms", tiers: [10, 15, 25] },
      { name: "SurveyMonkey", tiers: [25, 35, 75] },
      { name: "Formstack", tiers: [50, 83, 208] }
    ]
  },
  "Social Media": {
    icon: icons.social,
    tools: [
      { name: "Buffer", tiers: [6, 12, 120] },
      { name: "Hootsuite", tiers: [99, 249, 739] },
      { name: "Later", tiers: [18, 40, 80] },
      { name: "Sprout Social", tiers: [249, 399, 499] },
      { name: "SocialBee", tiers: [29, 49, 99] },
      { name: "Planoly", tiers: [13, 23, 43] }
    ]
  },
  "Dashboards & BI": {
    icon: icons.dashboard,
    tools: [
      { name: "Tableau", tiers: [70, 70, 70] },
      { name: "Power BI", tiers: [10, 20, 20] },
      { name: "Metabase", tiers: [0, 85, 85] },
      { name: "Databox", tiers: [47, 135, 231] },
      { name: "Klipfolio", tiers: [49, 199, 799] }
    ]
  },
  "Support & Help Desk": {
    icon: icons.support,
    tools: [
      { name: "Zendesk", tiers: [19, 49, 99] },
      { name: "Freshdesk", tiers: [15, 49, 79] },
      { name: "Help Scout", tiers: [20, 40, 65] },
      { name: "Intercom", tiers: [74, 119, 219] },
      { name: "Front", tiers: [19, 49, 99] },
      { name: "Groove", tiers: [12, 20, 40] }
    ]
  },
  "Invoicing & Accounting": {
    icon: icons.invoice,
    tools: [
      { name: "QuickBooks Online", tiers: [30, 60, 90] },
      { name: "Xero", tiers: [13, 37, 70] },
      { name: "FreshBooks", tiers: [17, 30, 55] },
      { name: "Zoho Books", tiers: [15, 40, 60] }
    ]
  },
  "Time Tracking": {
    icon: icons.time,
    tools: [
      { name: "Toggl Track", tiers: [10, 20, 30] },
      { name: "Harvest", tiers: [12, 12, 12] },
      { name: "Clockify", tiers: [0, 4.99, 9.99] },
      { name: "Timely", tiers: [9, 16, 22] },
      { name: "Hubstaff", tiers: [7, 10, 20] }
    ]
  },
  "Communication": {
    icon: icons.communication,
    tools: [
      { name: "Slack", tiers: [7.25, 12.50, 15] },
      { name: "Microsoft Teams", tiers: [6, 12.50, 22] },
      { name: "Zoom", tiers: [12.50, 16.67, 25] },
      { name: "Google Workspace", tiers: [6, 12, 18] },
      { name: "Microsoft 365", tiers: [6, 12.50, 22] }
    ]
  },
  "Automation": {
    icon: icons.automation,
    tools: [
      { name: "Zapier", tiers: [19.99, 49, 299] },
      { name: "Make", tiers: [9, 16, 29] },
      { name: "n8n", tiers: [0, 20, 50] }
    ]
  },
  "Document Management": {
    icon: icons.document,
    tools: [
      { name: "Google Drive", tiers: [6, 12, 18] },
      { name: "Dropbox", tiers: [12, 18, 24] },
      { name: "OneDrive", tiers: [6, 12.50, 22] },
      { name: "Box", tiers: [5, 15, 25] }
    ]
  },
  "E-signature": {
    icon: icons.signature,
    tools: [
      { name: "DocuSign", tiers: [10, 25, 40] },
      { name: "PandaDoc", tiers: [19, 49, 65] },
      { name: "HelloSign", tiers: [15, 25, 40] },
      { name: "SignNow", tiers: [8, 15, 25] }
    ]
  },
  "Scheduling": {
    icon: icons.calendar,
    tools: [
      { name: "Calendly", tiers: [8, 12, 16] },
      { name: "Acuity", tiers: [16, 27, 49] }
    ]
  },
  "Marketing": {
    icon: icons.marketing,
    tools: [
      { name: "Mailchimp", tiers: [13, 20, 350] },
      { name: "Constant Contact", tiers: [12, 35, 80] },
      { name: "ConvertKit", tiers: [9, 25, 50] }
    ]
  },
  "Collaboration & Wikis": {
    icon: icons.collaboration,
    tools: [
      { name: "Coda", tiers: [10, 30, 50] },
      { name: "Confluence", tiers: [5.75, 11, 22.05] },
      { name: "Guru", tiers: [5, 10, 20] },
      { name: "Slite", tiers: [8, 12.50, 15] }
    ]
  },
  "HR & Payroll": {
    icon: icons.hr,
    tools: [
      { name: "Gusto", tiers: [40, 80, 120] },
      { name: "Rippling", tiers: [8, 16, 25] }
    ]
  }
};

const wasteCategories = [
  {
    id: "ductTape",
    name: "Duct-tape Labor",
    description: "Hours copying data between tools, fixing automations, updating multiple systems",
    defaultHours: 10,
    defaultRate: 40
  },
  {
    id: "emailArchaeology",
    name: "Email Archaeology",
    description: "Hours searching emails for client info, attachments, or project history",
    defaultHours: 10,
    defaultRate: 40
  },
  {
    id: "spreadsheetHell",
    name: "Spreadsheet Hell",
    description: "Hours updating/reconciling spreadsheets and dealing with version control issues",
    defaultHours: 10,
    defaultRate: 40
  },
  {
    id: "fileHunting",
    name: "File Hunting",
    description: "Hours searching for the latest version of files across systems",
    defaultHours: 10,
    defaultRate: 40
  },
  {
    id: "statusMeetings",
    name: "Status Meetings",
    description: "Hours in meetings that exist only because there's no dashboard or single source of truth",
    defaultHours: 10,
    defaultRate: 40
  }
];

const aiAgents = [
  { id: "contextAgent", name: "Company Context Agent", description: "Instant answers to business questions", prevHours: 4, newHours: 0.5, rate: 50 },
  { id: "customerService", name: "Customer Service AI", description: "AI handles routine client inquiries", prevHours: 6, newHours: 2, rate: 50 },
  { id: "salesAssistant", name: "Sales Assistant", description: "Pre-call briefings with past quotes and history", prevHours: 5, newHours: 1, rate: 50 },
  { id: "financialInsights", name: "Financial Insights", description: "Real-time financial answers and reports", prevHours: 4, newHours: 1, rate: 50 },
  { id: "proposalGenerator", name: "Proposal Generator", description: "AI drafts proposals from templates", prevHours: 5, newHours: 1.5, rate: 50 },
  { id: "projectKickoff", name: "Project Kickoff Agent", description: "Auto-generates project setup docs", prevHours: 4, newHours: 1, rate: 50 },
  { id: "timesheetApproval", name: "Timesheet Approval Agent", description: "AI flags timesheet anomalies", prevHours: 3, newHours: 1.5, rate: 50 },
  { id: "clientOnboarding", name: "Client Onboarding Agent", description: "Automated onboarding workflow", prevHours: 4, newHours: 1, rate: 50 },
  { id: "semanticSearch", name: "Intelligent Semantic Search", description: "Natural language search across all data", prevHours: 3, newHours: 1, rate: 50 },
  { id: "meetingPrep", name: "Meeting Prep Agent", description: "AI-generated meeting briefings", prevHours: 4, newHours: 1, rate: 50 }
];

const apgTiers = [
  { tier: 1, oneTime: 65000, monthly: 999 },
  { tier: 2, oneTime: 95000, monthly: 999 },
  { tier: 3, oneTime: 125000, monthly: 999 }
];

// ============================================
// STATE
// ============================================

let currentStep = 1;
let selectedTools = {};
let wasteInputs = {};
let selectedAIAgents = {};
let selectedAPGTier = 3;
let expandedCategories = new Set();

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  initializeToolCategories();
  initializeWasteCategories();
  initializeAIAgents();
  initializeTierSelection();
  initializeNavigation();
  calculateTotals();
});

function initializeToolCategories() {
  const container = document.getElementById('toolCategories');
  container.innerHTML = '';

  Object.entries(toolsData).forEach(([category, data]) => {
    const categoryId = category.replace(/\s+/g, '-').toLowerCase();

    const section = document.createElement('div');
    section.className = `category-section${expandedCategories.has(categoryId) ? ' expanded' : ''}`;
    section.id = `category-${categoryId}`;

    const selectedCount = Object.values(selectedTools)
      .filter(t => t.category === category && t.selected).length;

    section.innerHTML = `
      <div class="category-header">
        <div class="category-title">
          <span class="category-icon">${data.icon}</span>
          <span>${category}</span>
          ${selectedCount > 0 ? `<span class="category-badge">${selectedCount} selected</span>` : ''}
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <span class="category-cost" id="cost-${categoryId}">$0/mo</span>
          <span class="category-chevron">▼</span>
        </div>
      </div>
      <div class="category-tools">
        ${data.tools.map(tool => {
          const toolId = `${categoryId}-${tool.name.replace(/\s+/g, '-').toLowerCase()}`;
          const toolState = selectedTools[toolId] || { selected: false, tier: 1, users: 5 };
          const isSelected = toolState.selected;
          const selectedTier = toolState.tier;
          const users = toolState.users;
          const cost = isSelected ? tool.tiers[selectedTier - 1] * users : 0;

          return `
            <div class="tool-item ${isSelected ? 'selected' : ''}" data-tool-id="${toolId}">
              <div class="tool-name-section">
                <div class="tool-checkbox ${isSelected ? 'checked' : ''}" data-tool="${toolId}"></div>
                <span class="tool-name">${tool.name}</span>
              </div>
              <div class="tier-select">
                ${tool.tiers.map((price, i) => `
                  <button class="tier-btn ${selectedTier === i + 1 ? 'active' : ''}"
                          data-tool="${toolId}"
                          data-tier="${i + 1}"
                          ${!isSelected ? 'disabled' : ''}>
                    T${i + 1} $${price}
                  </button>
                `).join('')}
              </div>
              <div class="user-count">
                <input type="number" class="user-count-input" value="${users}" min="1" max="1000"
                       data-tool="${toolId}" ${!isSelected ? 'disabled' : ''}>
                <span class="user-count-label">users</span>
              </div>
              <div class="tool-cost">${isSelected ? '$' + cost.toFixed(0) + '/mo' : '-'}</div>
            </div>
          `;
        }).join('')}
      </div>
    `;

    // Store tool data for calculations
    data.tools.forEach(tool => {
      const toolId = `${categoryId}-${tool.name.replace(/\s+/g, '-').toLowerCase()}`;
      if (!selectedTools[toolId]) {
        selectedTools[toolId] = {
          category: category,
          name: tool.name,
          tiers: tool.tiers,
          selected: false,
          tier: 1,
          users: 5
        };
      }
    });

    container.appendChild(section);
  });

  // Add event listeners
  document.querySelectorAll('.category-header').forEach(header => {
    header.addEventListener('click', () => {
      const section = header.parentElement;
      const categoryId = section.id.replace('category-', '');
      if (expandedCategories.has(categoryId)) {
        expandedCategories.delete(categoryId);
        section.classList.remove('expanded');
      } else {
        expandedCategories.add(categoryId);
        section.classList.add('expanded');
      }
    });
  });

  document.querySelectorAll('.tool-checkbox').forEach(checkbox => {
    checkbox.addEventListener('click', (e) => {
      e.stopPropagation();
      const toolId = checkbox.dataset.tool;
      selectedTools[toolId].selected = !selectedTools[toolId].selected;
      initializeToolCategories();
      calculateTotals();
    });
  });

  document.querySelectorAll('.tier-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const toolId = btn.dataset.tool;
      const tier = parseInt(btn.dataset.tier);
      selectedTools[toolId].tier = tier;
      initializeToolCategories();
      calculateTotals();
    });
  });

  document.querySelectorAll('.user-count-input').forEach(input => {
    input.addEventListener('change', (e) => {
      const toolId = input.dataset.tool;
      selectedTools[toolId].users = parseInt(input.value) || 1;
      initializeToolCategories();
      calculateTotals();
    });
    input.addEventListener('click', (e) => e.stopPropagation());
  });

  // Update category costs
  Object.entries(toolsData).forEach(([category, data]) => {
    const categoryId = category.replace(/\s+/g, '-').toLowerCase();
    let categoryCost = 0;
    data.tools.forEach(tool => {
      const toolId = `${categoryId}-${tool.name.replace(/\s+/g, '-').toLowerCase()}`;
      const toolState = selectedTools[toolId];
      if (toolState && toolState.selected) {
        categoryCost += tool.tiers[toolState.tier - 1] * toolState.users;
      }
    });
    const costEl = document.getElementById(`cost-${categoryId}`);
    if (costEl) {
      costEl.textContent = categoryCost > 0 ? `$${formatNumber(categoryCost)}/mo` : '$0/mo';
    }
  });
}

function initializeWasteCategories() {
  const container = document.getElementById('wasteCategories');
  container.innerHTML = '';

  wasteCategories.forEach(waste => {
    if (!wasteInputs[waste.id]) {
      wasteInputs[waste.id] = {
        hours: waste.defaultHours,
        rate: waste.defaultRate
      };
    }

    const cost = wasteInputs[waste.id].hours * wasteInputs[waste.id].rate * 4; // Monthly

    const item = document.createElement('div');
    item.className = 'waste-item';
    item.innerHTML = `
      <div class="waste-header">
        <div>
          <div class="waste-title">${waste.name}</div>
          <div class="waste-description">${waste.description}</div>
        </div>
        <div class="waste-cost" id="waste-cost-${waste.id}">$${formatNumber(cost)}/mo</div>
      </div>
      <div class="waste-inputs">
        <div class="input-group">
          <label class="input-label">Hours per week (team-wide)</label>
          <div class="slider-wrapper">
            <input type="range" class="slider" min="0" max="80" value="${wasteInputs[waste.id].hours}"
                   data-waste="${waste.id}" data-type="hours">
            <div class="slider-value" id="waste-hours-${waste.id}">${wasteInputs[waste.id].hours}h</div>
          </div>
        </div>
        <div class="input-group">
          <label class="input-label">Hourly labor rate ($)</label>
          <div class="slider-wrapper">
            <input type="range" class="slider" min="20" max="150" value="${wasteInputs[waste.id].rate}"
                   data-waste="${waste.id}" data-type="rate">
            <div class="slider-value" id="waste-rate-${waste.id}">$${wasteInputs[waste.id].rate}</div>
          </div>
        </div>
      </div>
    `;
    container.appendChild(item);
  });

  // Add event listeners
  document.querySelectorAll('#wasteCategories .slider').forEach(slider => {
    slider.addEventListener('input', (e) => {
      const wasteId = slider.dataset.waste;
      const type = slider.dataset.type;
      wasteInputs[wasteId][type] = parseInt(slider.value);

      // Update display
      if (type === 'hours') {
        document.getElementById(`waste-hours-${wasteId}`).textContent = slider.value + 'h';
      } else {
        document.getElementById(`waste-rate-${wasteId}`).textContent = '$' + slider.value;
      }

      // Update cost
      const cost = wasteInputs[wasteId].hours * wasteInputs[wasteId].rate * 4;
      document.getElementById(`waste-cost-${wasteId}`).textContent = '$' + formatNumber(cost) + '/mo';

      calculateTotals();
    });
  });
}

function initializeAIAgents() {
  const container = document.getElementById('aiAgents');
  container.innerHTML = '';

  aiAgents.forEach(agent => {
    if (selectedAIAgents[agent.id] === undefined) {
      selectedAIAgents[agent.id] = true; // Default all ON
    }

    const isActive = selectedAIAgents[agent.id];
    const weeklySavings = (agent.prevHours - agent.newHours) * agent.rate;
    const monthlySavings = weeklySavings * 4;

    const item = document.createElement('div');
    item.className = 'ai-agent-item';
    item.innerHTML = `
      <div class="ai-toggle ${isActive ? 'active' : ''}" data-agent="${agent.id}"></div>
      <div class="ai-info">
        <h4>${agent.name}</h4>
        <p>${agent.description}</p>
      </div>
      <div class="ai-savings">
        <div class="ai-savings-amount">${isActive ? '$' + formatNumber(monthlySavings) : '-'}</div>
        <div class="ai-savings-label">${isActive ? 'monthly opportunity' : 'disabled'}</div>
      </div>
    `;
    container.appendChild(item);
  });

  // Add event listeners
  document.querySelectorAll('.ai-toggle').forEach(toggle => {
    toggle.addEventListener('click', () => {
      const agentId = toggle.dataset.agent;
      selectedAIAgents[agentId] = !selectedAIAgents[agentId];
      initializeAIAgents();
      calculateTotals();
    });
  });
}

function initializeTierSelection() {
  document.querySelectorAll('.tier-card').forEach(card => {
    card.addEventListener('click', () => {
      document.querySelectorAll('.tier-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      selectedAPGTier = parseInt(card.dataset.tier);
      calculateTotals();
    });
  });
}

function initializeNavigation() {
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  prevBtn.addEventListener('click', () => {
    if (currentStep > 1) {
      goToStep(currentStep - 1);
    }
  });

  nextBtn.addEventListener('click', () => {
    if (currentStep < 5) {
      goToStep(currentStep + 1);
    }
  });

  // Step indicators click
  document.querySelectorAll('.step-indicator').forEach(indicator => {
    indicator.addEventListener('click', () => {
      const step = parseInt(indicator.dataset.step);
      goToStep(step);
    });
  });
}

function goToStep(step) {
  currentStep = step;

  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach(indicator => {
    const indicatorStep = parseInt(indicator.dataset.step);
    indicator.classList.remove('active', 'completed');
    if (indicatorStep === currentStep) {
      indicator.classList.add('active');
    } else if (indicatorStep < currentStep) {
      indicator.classList.add('completed');
    }
  });

  // Update step content
  document.querySelectorAll('.step-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(`step${currentStep}`).classList.add('active');

  // Update nav buttons
  document.getElementById('prevBtn').disabled = currentStep === 1;
  document.getElementById('nextBtn').textContent = currentStep === 5 ? 'Start Over' : 'Next Step';

  if (currentStep === 5) {
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentStep === 5) {
        goToStep(1);
      }
    }, { once: true });
    updateSummary();
  }

  // Update height for iframe
  updateHeight();
}

// ============================================
// CALCULATIONS
// ============================================

function calculateTotals() {
  // Calculate SaaS tools cost
  let toolsCost = 0;
  Object.values(selectedTools).forEach(tool => {
    if (tool.selected) {
      toolsCost += tool.tiers[tool.tier - 1] * tool.users;
    }
  });

  // Calculate inefficiency waste
  let wasteCost = 0;
  Object.values(wasteInputs).forEach(waste => {
    wasteCost += waste.hours * waste.rate * 4; // Monthly
  });

  // Calculate AI enablement opportunity
  let aiCost = 0;
  aiAgents.forEach(agent => {
    if (selectedAIAgents[agent.id]) {
      const weeklySavings = (agent.prevHours - agent.newHours) * agent.rate;
      aiCost += weeklySavings * 4;
    }
  });

  const totalWaste = toolsCost + wasteCost; // Net Waste = SaaS + Inefficiency only

  // Update running totals
  document.getElementById('runningToolsCost').textContent = '$' + formatNumber(toolsCost);
  document.getElementById('runningWasteCost').textContent = '$' + formatNumber(wasteCost);
  document.getElementById('runningAICost').textContent = '$' + formatNumber(aiCost);
  document.getElementById('runningTotalWaste').textContent = '$' + formatNumber(totalWaste);

  return { toolsCost, wasteCost, aiCost, totalWaste };
}

function updateSummary() {
  const { toolsCost, wasteCost, aiCost, totalWaste } = calculateTotals();
  const annualWaste = totalWaste * 12;
  const annualAISavings = aiCost * 12;

  const tier = apgTiers.find(t => t.tier === selectedAPGTier);
  const year1Investment = tier.oneTime + (tier.monthly * 6); // Maintenance starts month 7

  // Calculate break-even
  let breakEvenMonth = 0;
  let cumulativeSavings = 0;
  let cumulativeInvestment = tier.oneTime;

  for (let month = 1; month <= 36; month++) {
    cumulativeSavings += totalWaste;
    if (month >= 7) {
      cumulativeInvestment += tier.monthly;
    }
    if (cumulativeSavings >= cumulativeInvestment && breakEvenMonth === 0) {
      breakEvenMonth = month;
    }
  }

  // Update summary cards
  document.getElementById('summaryMonthlyWaste').textContent = '$' + formatNumber(totalWaste);
  document.getElementById('summaryAnnualWaste').textContent = '$' + formatNumber(annualWaste);
  document.getElementById('summaryInvestment').textContent = '$' + formatNumber(tier.oneTime);
  document.getElementById('summaryBreakeven').textContent = breakEvenMonth > 0 ? `Month ${breakEvenMonth}` : 'N/A';

  // Update breakdown
  const breakdown = document.getElementById('costBreakdown');
  const threeYearSavings = (totalWaste * 36) - (tier.oneTime + tier.monthly * 30);
  breakdown.innerHTML = `
    <div class="breakdown-item">
      <span class="breakdown-label">SaaS Tools (monthly)</span>
      <span class="breakdown-value negative">$${formatNumber(toolsCost)}</span>
    </div>
    <div class="breakdown-item">
      <span class="breakdown-label">Inefficiency Waste (monthly)</span>
      <span class="breakdown-value negative">$${formatNumber(wasteCost)}</span>
    </div>
    <div class="breakdown-item">
      <span class="breakdown-label"><strong>Total Monthly Waste</strong></span>
      <span class="breakdown-value negative"><strong>$${formatNumber(totalWaste)}</strong></span>
    </div>
    <div class="breakdown-item" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid rgba(255,255,255,0.1);">
      <span class="breakdown-label">AI Enablement Savings (monthly)</span>
      <span class="breakdown-value positive">+$${formatNumber(aiCost)}</span>
    </div>
    <div class="breakdown-item" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid rgba(255,255,255,0.1);">
      <span class="breakdown-label">APG One-Time Investment</span>
      <span class="breakdown-value">$${formatNumber(tier.oneTime)}</span>
    </div>
    <div class="breakdown-item">
      <span class="breakdown-label">Monthly Maintenance (from month 7)</span>
      <span class="breakdown-value">$${formatNumber(tier.monthly)}</span>
    </div>
    <div class="breakdown-item" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid rgba(255,255,255,0.1);">
      <span class="breakdown-label"><strong>3-Year Net Savings</strong></span>
      <span class="breakdown-value positive"><strong>$${formatNumber(threeYearSavings)}</strong></span>
    </div>
  `;

  // Draw chart
  drawChart(totalWaste, tier);
}

function drawChart(monthlyWaste, tier) {
  const canvas = document.getElementById('roiChart');
  const ctx = canvas.getContext('2d');

  // Set canvas size
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width - 48;
  canvas.height = 340;

  const width = canvas.width;
  const height = canvas.height;
  const padding = { top: 50, right: 20, bottom: 40, left: 70 };
  const chartWidth = width - padding.left - padding.right;
  const chartHeight = height - padding.top - padding.bottom;

  // Generate data points
  const wasteData = [];
  const investmentData = [];
  let cumulativeWaste = 0;
  let cumulativeInvestment = tier.oneTime;

  for (let month = 0; month <= 36; month++) {
    if (month > 0) {
      cumulativeWaste += monthlyWaste;
      if (month >= 7) {
        cumulativeInvestment += tier.monthly;
      }
    }
    wasteData.push({ month, value: cumulativeWaste });
    investmentData.push({ month, value: cumulativeInvestment });
  }

  const maxValue = Math.max(cumulativeWaste, cumulativeInvestment);
  const yScale = chartHeight / maxValue;
  const xScale = chartWidth / 36;

  // Clear canvas
  ctx.clearRect(0, 0, width, height);

  // Draw grid lines
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;

  for (let i = 0; i <= 5; i++) {
    const y = padding.top + (chartHeight / 5) * i;
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(width - padding.right, y);
    ctx.stroke();

    // Y-axis labels
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.font = '11px Inter';
    ctx.textAlign = 'right';
    const value = maxValue - (maxValue / 5) * i;
    ctx.fillText('$' + formatNumber(value), padding.left - 10, y + 4);
  }

  // X-axis labels
  ctx.textAlign = 'center';
  for (let month = 0; month <= 36; month += 6) {
    const x = padding.left + month * xScale;
    ctx.fillText('M' + month, x, height - 10);
  }

  // Draw investment line
  ctx.beginPath();
  ctx.strokeStyle = 'rgba(255,255,255,0.6)';
  ctx.lineWidth = 2;
  investmentData.forEach((point, i) => {
    const x = padding.left + point.month * xScale;
    const y = padding.top + chartHeight - (point.value * yScale);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Draw waste line
  ctx.beginPath();
  ctx.strokeStyle = '#7DFF00';
  ctx.lineWidth = 3;
  wasteData.forEach((point, i) => {
    const x = padding.left + point.month * xScale;
    const y = padding.top + chartHeight - (point.value * yScale);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Find and mark break-even point
  for (let i = 1; i < wasteData.length; i++) {
    if (wasteData[i].value >= investmentData[i].value) {
      const x = padding.left + wasteData[i].month * xScale;
      const y = padding.top + chartHeight - (wasteData[i].value * yScale);

      ctx.beginPath();
      ctx.arc(x, y, 6, 0, Math.PI * 2);
      ctx.fillStyle = '#7DFF00';
      ctx.fill();

      ctx.fillStyle = '#7DFF00';
      ctx.font = 'bold 12px Inter';
      ctx.textAlign = 'center';
      ctx.fillText('Break-even', x, y - 15);
      break;
    }
  }

  // Legend - positioned at top
  ctx.font = '12px Inter';
  ctx.textAlign = 'left';

  ctx.fillStyle = '#7DFF00';
  ctx.fillRect(padding.left, 15, 12, 12);
  ctx.fillStyle = 'rgba(255,255,255,0.8)';
  ctx.fillText('Cumulative Waste Savings', padding.left + 18, 25);

  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  ctx.fillRect(padding.left + 200, 15, 12, 12);
  ctx.fillStyle = 'rgba(255,255,255,0.8)';
  ctx.fillText('APG Investment', padding.left + 218, 25);
}

// ============================================
// UTILITIES
// ============================================

function formatNumber(num) {
  return Math.round(num).toLocaleString('en-US');
}

// Height communication for iframe
let lastSentHeight = 0;
let heightUpdateTimeout = null;

function updateHeight() {
  try {
    const height = Math.max(
      document.body.scrollHeight,
      document.body.offsetHeight,
      document.documentElement.clientHeight,
      document.documentElement.scrollHeight,
      document.documentElement.offsetHeight
    );

    if (Math.abs(height - lastSentHeight) < 10) return;

    lastSentHeight = height;
    window.parent.postMessage({ type: 'resize', height: height }, '*');
  } catch (error) {
    console.log('PostMessage not available:', error);
  }
}

function updateHeightDelayed() {
  if (heightUpdateTimeout) clearTimeout(heightUpdateTimeout);
  heightUpdateTimeout = setTimeout(updateHeight, 150);
}

window.addEventListener('resize', updateHeightDelayed);
window.addEventListener('load', updateHeightDelayed);

const observer = new MutationObserver(updateHeightDelayed);
observer.observe(document.body, {
  childList: true,
  subtree: true,
  attributes: true,
  attributeFilter: ['style', 'class']
});
</script>
</body>
</html>
